<!-- index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark only">
    <title>Super Bowl Prediction Game</title>

    <!-- Favicon - Seahawks themed -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='80'>üèà</text></svg>">
    <link rel="apple-touch-icon" href="favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Confetti loaded on demand -->
    <script defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { init } from 'https://cdn.jsdelivr.net/npm/@instantdb/core/+esm';
        window.InstantDBInit = init;
    </script>
    <!-- Vite module entry point - sets window.VITE_APP_ID -->
    <script type="module" src="/src/main.ts"></script>
    <script>
        // Configure Tailwind to use CSS custom properties for dynamic theming
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Dynamic theme colors via CSS variables
                        'primary': 'var(--color-primary)',
                        'base-100': 'var(--color-background)',
                        'base-200': 'var(--color-background-alt)',
                        'base-300': '#001525',
                        // Static colors (not themed)
                        'success': 'var(--color-primary)',
                        'error': '#ff6b6b',
                        'info': '#60a5fa',
                        'warning': '#fbbf24',
                    }
                }
            }
        }
    </script>
</head>
<body data-theme="seahawks" class="bg-base-100 min-h-screen">
    <!-- Header -->
    <div class="app-header sticky top-0 z-50 shadow-lg" style="background: linear-gradient(135deg, #00203B 0%, #002a4a 50%, #00203B 100%); background-color: #00203B;">
        <button id="soundToggle" class="sound-toggle" onclick="SoundManager.toggle()" title="Toggle sound">
            üîá
        </button>
        <button id="introReplayBtn" class="intro-replay-btn hidden" onclick="replayIntro()" title="See intro again">
            üì∑
        </button>
        <div class="header-content">
            <div class="header-matchup">
                <span class="matchup-text">Seahawks vs Pats</span>
            </div>
            <img src="images/superbowl-lx-logo.svg" alt="Super Bowl LX" class="header-logo" width="121" height="80" />
            <div class="header-title">
                <span class="title-text">Predictions</span>
            </div>
            <div id="leagueNameHeader" class="hidden" style="margin-top: 6px;">
                <span class="league-name-header"></span>
            </div>
        </div>
        <!-- Progress bar below header -->
        <div id="progressBarContainer" class="progress-bar-container hidden">
            <div id="progressBar" class="progress-bar"></div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-2xl">
        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center min-h-screen">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>

        <!-- League Creation -->
        <div id="leagueCreation" class="hidden">
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-primary">Create Your League</h2>
                    <p class="text-base-content/80">Enter a name for your prediction league. You'll get a shareable link to invite others!</p>

                    <form id="leagueForm" class="space-y-4 mt-4">
                        <div class="form-control">
                            <label class="label" for="leagueName">
                                <span class="label-text text-base-content">League Name</span>
                            </label>
                            <input type="text" id="leagueName" required placeholder="e.g., Good Vibes"
                                class="input input-bordered input-primary w-full text-lg" />
                        </div>
                        <button type="submit" class="btn btn-primary w-full btn-lg">Create League</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- League Not Found -->
        <div id="leagueNotFound" class="hidden">
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-primary">League Not Found</h2>
                    <p class="text-base-content/80">The league you're looking for doesn't exist or has been deleted.</p>
                    <p id="notFoundSlug" class="text-sm text-base-content/60 mt-2"></p>

                    <div class="divider">What would you like to do?</div>

                    <div class="space-y-3">
                        <button onclick="showLeagueCreation()" class="btn btn-primary w-full btn-lg">
                            Create a New League
                        </button>
                        <button onclick="clearLeagueAndReload()" class="btn btn-outline btn-secondary w-full">
                            Enter a Different League
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- League URL stored for copy function -->
        <div id="shareUrl" class="hidden"></div>

        <!-- Team Name Entry -->
        <div id="teamNameEntry" class="hidden">
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-primary">Enter Your Team Name</h2>
                    <p class="text-base-content/80">Choose a unique name for your team in this league.</p>
                    <p class="text-sm mt-2" style="color: #f59e0b;">‚ö†Ô∏è Choose carefully ‚Äî only admins can change team names later.</p>

                    <form id="teamNameForm" class="space-y-4 mt-4">
                        <div class="form-control">
                            <label class="label" for="teamNameInput">
                                <span class="label-text text-base-content">Your Team Name</span>
                            </label>
                            <input type="text" id="teamNameInput" required placeholder="e.g., John's Picks"
                                minlength="3" maxlength="15"
                                class="input input-bordered input-primary w-full text-lg" />
                        </div>
                        <button type="submit" class="btn btn-primary w-full btn-lg">Continue</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Intro Overlay (shown after team registration) -->
        <div id="introOverlay" class="intro-overlay hidden">
            <img id="introImage" class="intro-image" src="" alt="Seahawks" />
            <div class="intro-content">
                <div class="intro-football-container">
                    <div class="intro-football">üèà</div>
                    <div class="intro-football-shadow"></div>
                </div>
                <div class="intro-title">Welcome to the Game!</div>
                <div id="introTeamName" class="intro-team-name"></div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toastNotification" class="toast-notification"></div>

        <!-- Team Name Edit Modal -->
        <dialog id="teamNameModal" class="modal">
            <div class="modal-box bg-base-200">
                <h3 id="teamNameModalTitle" class="font-bold text-lg text-primary mb-4">Edit Team Name</h3>
                <form id="teamNameEditForm" class="space-y-4">
                    <div class="form-control">
                        <label class="label" for="teamNameEditInput">
                            <span class="label-text text-base-content">New Team Name</span>
                        </label>
                        <input type="text" id="teamNameEditInput" required
                            minlength="3" maxlength="15"
                            placeholder="Enter team name"
                            class="input input-bordered input-primary w-full text-lg"
                            oninput="updateTeamNameCharCount()" />
                        <div id="teamNameCharCount" class="char-count char-count-valid">0/15 characters (min 3)</div>
                    </div>
                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="closeTeamNameModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <!-- Delete Team Confirmation Modal -->
        <dialog id="deleteTeamModal" class="modal delete-confirm-modal">
            <div class="modal-box bg-base-200" style="background: linear-gradient(135deg, #1a0f0f 0%, #2d1515 100%); border: 2px solid #ff6b6b;">
                <h3 class="font-bold text-lg mb-4" style="color: #ff6b6b;">Delete Team</h3>
                <p class="mb-2" style="color: #FFFFFF;">Are you sure you want to delete <strong id="deleteTeamName" style="color: #ff6b6b;"></strong>?</p>
                <p class="text-sm mb-4" style="color: #ff9999;">This action cannot be undone. All predictions for this team will be permanently removed.</p>
                <input type="hidden" id="deleteTeamId" value="" />
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
                    <button type="button" class="btn btn-delete" onclick="confirmDeleteTeam()">Delete Team</button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <!-- Admin Panel (for league creator) -->
        <div id="adminPanel" class="hidden">
            <div role="tablist" class="tabs tabs-boxed bg-base-200 mb-6 sticky top-[120px] z-40 shadow-lg">
                <a role="tab" id="adminPredictionsTab" class="tab tab-active" onclick="switchTab('predictions')">My Predictions</a>
                <a role="tab" class="tab" onclick="switchTab('scores')">Scores</a>
                <a role="tab" id="adminResultsTab" class="tab tab-results" onclick="switchTab('results')">Results</a>
                <a role="tab" class="tab" onclick="switchTab('admin')">Admin</a>
            </div>

            <!-- Admin Controls Tab -->
            <div id="adminTab" class="hidden space-y-6">
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-0">
                        <button onclick="toggleGameStatus()" class="w-full p-4 flex justify-between items-center cursor-pointer" style="background: transparent; border: none;">
                            <h3 class="card-title text-primary m-0">Game Status</h3>
                            <span id="gameStatusToggleIcon" style="color: #33F200; font-size: 18px;">‚ñº</span>
                        </button>
                        <div id="gameStatusContent" class="px-4 pb-4">
                            <div id="gameStatus"></div>
                        </div>
                    </div>
                </div>

                <!-- Participants Section (collapsible) -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-0">
                        <button onclick="toggleParticipants()" class="w-full p-4 flex justify-between items-center cursor-pointer" style="background: transparent; border: none;">
                            <h3 class="card-title text-primary m-0">üë• Participants</h3>
                            <span id="participantsToggleIcon" style="color: #33F200; font-size: 18px;">‚ñ∂</span>
                        </button>
                        <div id="participantsContent" class="px-4 pb-4" style="display: none;">
                            <div id="participantsList" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Recalculate Scores Section (collapsible) -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-0">
                        <button onclick="toggleRecalculateScores()" class="w-full p-4 flex justify-between items-center cursor-pointer" style="background: transparent; border: none;">
                            <h3 class="card-title text-primary m-0">üîÑ Recalculate Scores</h3>
                            <span id="recalculateScoresToggleIcon" style="color: #33F200; font-size: 18px;">‚ñ∂</span>
                        </button>
                        <div id="recalculateScoresContent" class="px-4 pb-4" style="display: none;">
                            <p class="text-sm mb-4" style="color: #9DA2A3;">
                                Recalculate scores for all participants. Useful when someone submits predictions after results have been entered.
                            </p>
                            <button onclick="recalculateAllScores()" class="btn btn-primary w-full mb-4" id="recalculateScoresBtn">
                                üîÑ Recalculate All Scores
                            </button>
                            <div id="recalculateScoresStatus"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Regular User Panel (non-admin users) -->
        <div id="userPanel" class="hidden">
            <div id="userTabs" role="tablist" class="tabs tabs-boxed bg-base-200 mb-6 sticky top-[120px] z-40 shadow-lg">
                <a role="tab" id="userPredictionsTab" class="tab tab-active" onclick="switchUserTab('predictions')">My Predictions</a>
                <a role="tab" class="tab" onclick="switchUserTab('scores')">Scores</a>
            </div>
        </div>

        <!-- Results Tab (for admins and managers) -->
        <div id="resultsTab" class="hidden">
            <div class="card shadow-xl" style="background-color: #1a0f0f; border: 2px solid #e57373;">
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="background: #e57373; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; text-transform: uppercase;">Admin/Manager</span>
                        <h3 class="card-title" style="color: #e57373; margin: 0;">Enter Actual Results</h3>
                    </div>
                    <p class="text-sm" style="color: #9DA2A3;">
                        Results are saved automatically as you enter them. Scores update in real-time.
                    </p>
                    <p id="resultsAutoSaveStatus" class="text-sm text-success text-center font-semibold"></p>
                    <form id="resultsForm" class="space-y-4 mt-4">
                        <!-- Results form will be generated by JS -->
                    </form>
                </div>
            </div>
        </div>

        <!-- Predictions Form -->
        <div id="predictionsSection" class="hidden">
            <div id="submissionsStatus" class="mb-4"></div>

            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <p id="autoSaveStatus" class="text-sm text-success text-center font-semibold"></p>

                    <form id="predictionsForm" class="space-y-4 mt-4">
                        <!-- Questions will be generated by JS -->
                    </form>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboardSection" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-primary">üèÜ Leaderboard</h2>
            <div id="leaderboard" class="space-y-3"></div>

            <!-- All Predictions Table (only visible in Scores tab when enabled by admin) -->
            <div id="allPredictionsSection" class="hidden mt-8">
                <h2 class="text-3xl font-bold mb-6 text-primary">All Predictions</h2>
                <div class="overflow-x-auto" id="allPredictionsTable"></div>
            </div>
        </div>
    </div>

    <script>
        // InstantDB Configuration
        // APP_ID is provided by Vite via import.meta.env.VITE_INSTANTDB_APP_ID
        // The Vite entry point (main.ts) exposes it as window.VITE_APP_ID
        // Using a getter function since modules load after inline scripts parse
        function getAppId() {
            return window.VITE_APP_ID || '__INSTANTDB_APP_ID__';
        }
        let db;

        // Global state - delegates to AppState store when available
        // These getters/setters provide backward compatibility for inline code
        // while using the centralized store as the single source of truth
        Object.defineProperties(window, {
            currentLeague: {
                get() { return window.AppState?.getState().currentLeague ?? null; },
                set(v) { window.AppState?.setCurrentLeague(v); }
            },
            allPredictions: {
                get() { return window.AppState?.getState().allPredictions ?? []; },
                set(v) { window.AppState?.setAllPredictions(v); }
            },
            currentUserId: {
                get() { return window.AppState?.getState().currentUserId ?? null; },
                set(v) { window.AppState?.setCurrentUserId(v); }
            },
            currentTeamName: {
                get() { return window.AppState?.getState().currentTeamName ?? null; },
                set(v) { window.AppState?.setCurrentTeamName(v); }
            },
            isLeagueCreator: {
                get() { return window.AppState?.getState().isLeagueCreator ?? false; },
                set(v) { window.AppState?.setIsLeagueCreator(v); }
            },
            isManager: {
                get() { return window.AppState?.getState().isManager ?? false; },
                set(v) { window.AppState?.setIsManager(v); }
            },
            currentTab: {
                get() { return window.AppState?.getState().currentTab ?? 'predictions'; },
                set(v) { window.AppState?.setCurrentTab(v); }
            },
            hasShownCompletionCelebration: {
                get() { return window.AppState?.getState().hasShownCompletionCelebration ?? false; },
                set(v) { window.AppState?.setHasShownCompletionCelebration(v); }
            },
            previousActualResults: {
                get() { return window.AppState?.getState().previousActualResults ?? null; },
                set(v) { window.AppState?.setPreviousActualResults(v); }
            },
            hasUnviewedScoreUpdate: {
                get() { return window.AppState?.getState().hasUnviewedScoreUpdate ?? false; },
                set(v) { window.AppState?.setHasUnviewedScoreUpdate(v); }
            },
            expectedLeagueSlug: {
                get() { return window.AppState?.getState().expectedLeagueSlug ?? null; },
                set(v) { window.AppState?.setExpectedLeagueSlug(v); }
            }
        });

        // ========== SOUND MANAGER ==========
        // SoundManager - now provided by window.SoundManager from modules (src/sound/manager.ts)

        // ========== CELEBRATION FUNCTIONS ==========
        // introImages - now in ui/celebration.ts
        // shuffleArray - now in ui/celebration.ts
        // showIntroOverlay - now provided by window.showIntroOverlay from modules
        // replayIntro - now provided by window.replayIntro from modules
        // triggerWinnerCelebration - now provided by window.triggerWinnerCelebration from modules
        // showCompletionCelebration - now provided by window.showCompletionCelebration from modules
        // showToast - now provided by window.showToast from modules

        // Questions configuration
        const questions = [
            { id: 'winner', label: 'Who wins?', type: 'radio', options: ['Seahawks', 'Patriots'], points: 5 },
            { id: 'totalTDs', label: 'Total touchdowns?', type: 'number', points: 5 },
            { id: 'overtime', label: 'Overtime?', type: 'radio', options: ['Yes', 'No'], points: 5 },
            { id: 'winningMargin', label: 'Winning margin?', type: 'radio', options: ['1-7', '8-14', '15+'], points: 5 },
            { id: 'totalFieldGoals', label: 'Total field goals?', type: 'number', points: 5 },
            { id: 'firstHalfLeader', label: 'Halftime leader?', type: 'radio', options: ['Seahawks', 'Patriots', 'Tied'], points: 5 },
            // { id: 'longestTD', label: 'Longest TD?', type: 'radio', options: ['Under 20', '20-39', '40-50', '50+', '60+'], points: 5 },
            // { id: 'totalTurnovers', label: 'Total turnovers?', type: 'number', points: 5 },
            // { id: 'successfulTwoPoints', label: 'Successful 2-point conversion?', type: 'radio', options: ['Yes', 'No'], points: 5 },
            // { id: 'defensiveTD', label: 'Defensive/special teams TD?', type: 'radio', options: ['Yes', 'No'], points: 5 },
            // { id: 'finalScoreSumEvenOdd', label: 'Final score sum even/odd?', type: 'radio', options: ['Even', 'Odd'], points: 5 },
            // { id: 'seahawksTDs', label: 'Seahawks TDs?', type: 'number', points: 5 },
            // { id: 'patriotsTDs', label: 'Patriots TDs?', type: 'number', points: 5 },
            // { id: 'totalSacks', label: 'Total sacks?', type: 'number', points: 5 },
            { id: 'totalPoints', label: 'TIEBREAKER: Total combined points', type: 'number', points: 0 },
        ];

        // getUserId - now provided by window.getUserId from modules (src/utils/user.ts)

        // Initialize app
        function initApp() {
            console.log('=== INITIALIZING APP ===');

            // Initialize Sound Manager (now uses module version)
            SoundManager.init();

            // Initialize InstantDB
            const appId = getAppId();
            console.log('Using InstantDB App ID:', appId ? appId.substring(0, 8) + '...' : 'NOT SET');
            db = window.InstantDBInit({ appId: appId });
            console.log('InstantDB initialized:', db);

            currentUserId = window.getUserId();
            console.log('Current user ID:', currentUserId);

            // Check for league parameter and admin override
            const urlParams = new URLSearchParams(window.location.search);
            let leagueParam = urlParams.get('league');
            const isAdminOverride = urlParams.get('isAdmin') === 'true';

            // If no URL param, check localStorage for saved league
            if (!leagueParam) {
                const savedLeague = localStorage.getItem('currentLeagueSlug');
                if (savedLeague) {
                    leagueParam = savedLeague;
                    console.log('Restored league from localStorage:', leagueParam);
                    // Update URL to reflect the league (without reload)
                    const newUrl = `${window.location.pathname}?league=${leagueParam}`;
                    window.history.replaceState({}, '', newUrl);
                }
            }

            if (leagueParam) {
                // Track expected slug for "not found" handling
                expectedLeagueSlug = leagueParam;
                const gameId = window.GAME_ID || 'lx';

                // Subscribe to this specific league by slug
                db.subscribeQuery(
                    {
                        leagues: { $: { where: { gameId, slug: leagueParam } } },
                        predictions: { $: { where: { gameId } } }
                    },
                    (result) => {
                        console.log('=== INSTANTDB SUBSCRIPTION UPDATE ===');
                        console.log('Result:', result);

                        if (result.error) {
                            console.error('InstantDB error:', result.error);
                            return;
                        }

                        currentLeague = result.data.leagues[0];
                        console.log('Current league:', currentLeague);

                        // Detect actualResults changes
                        if (currentLeague) {
                            const currentActualResults = currentLeague.actualResults;

                            // Check if actualResults changed and user is not on scores tab
                            if (previousActualResults !== null &&
                                JSON.stringify(currentActualResults) !== JSON.stringify(previousActualResults) &&
                                currentTab !== 'scores') {

                                // Only show notification if results have content
                                if (currentActualResults && Object.keys(currentActualResults).length > 0) {
                                    hasUnviewedScoreUpdate = true;
                                    updateScoresTabNotification();
                                }
                            }

                            previousActualResults = currentActualResults ? JSON.parse(JSON.stringify(currentActualResults)) : null;
                        }

                        // Filter predictions for this league
                        if (currentLeague) {
                            allPredictions = result.data.predictions.filter(p => p.leagueId === currentLeague.id);
                            isLeagueCreator = currentLeague.creatorId === currentUserId || isAdminOverride;
                            console.log('Is league creator:', isLeagueCreator, '(creatorId:', currentLeague.creatorId, ', userId:', currentUserId, ', adminOverride:', isAdminOverride, ')');
                            console.log('All predictions:', allPredictions);
                        } else {
                            console.log('No league found with slug:', expectedLeagueSlug);
                            allPredictions = [];
                            // Clear localStorage since this league doesn't exist
                            localStorage.removeItem('currentLeagueSlug');
                        }

                        render();
                    }
                );
            } else {
                // No league parameter - show league creation
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('leagueCreation').classList.remove('hidden');
                document.getElementById('leagueForm').onsubmit = handleLeagueCreation;
            }
        }

        // Handle league creation
        async function handleLeagueCreation(e) {
            e.preventDefault();

            const leagueName = document.getElementById('leagueName').value.trim();
            const leagueSlug = leagueName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const gameId = window.GAME_ID || 'lx';

            // Check if a league with this slug already exists
            const existingLeague = await db.queryOnce({
                leagues: { $: { where: { gameId, slug: leagueSlug } } }
            });

            if (existingLeague.data.leagues && existingLeague.data.leagues.length > 0) {
                alert('A league with this name already exists. Please choose a different name.');
                return;
            }

            // Generate UUID for league
            const leagueId = crypto.randomUUID();

            // Create league
            await db.transact([
                db.tx.leagues[leagueId].update({
                    gameId: gameId,
                    slug: leagueSlug,
                    name: leagueName,
                    creatorId: currentUserId,
                    isOpen: true,
                    createdAt: Date.now()
                })
            ]);

            // Update URL
            const newUrl = `${window.location.pathname}?league=${leagueSlug}`;
            window.history.pushState({}, '', newUrl);

            // Reload to initialize with league
            window.location.reload();
        }

        // copyLeagueUrl - now provided by window.copyLeagueUrl from modules

        // Show league not found screen
        function showLeagueNotFound(slug) {
            document.getElementById('leagueNotFound').classList.remove('hidden');
            document.getElementById('notFoundSlug').textContent = `League slug: "${slug}"`;
            // Hide other screens
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('leagueCreation').classList.add('hidden');
            document.getElementById('teamNameEntry').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('userPanel').classList.add('hidden');
        }

        // Show the league creation form from the not found screen
        function showLeagueCreation() {
            document.getElementById('leagueNotFound').classList.add('hidden');
            document.getElementById('leagueCreation').classList.remove('hidden');
            document.getElementById('leagueForm').onsubmit = handleLeagueCreation;
            // Clear expected slug so we don't show not found again
            expectedLeagueSlug = null;
            // Clear URL parameter
            window.history.replaceState({}, '', window.location.pathname);
        }

        // Clear stored league and reload to show creation/join options
        function clearLeagueAndReload() {
            localStorage.removeItem('currentLeagueSlug');
            expectedLeagueSlug = null;
            // Clear URL and reload
            window.history.replaceState({}, '', window.location.pathname);
            window.location.reload();
        }

        // Render UI
        function render() {
            console.log('=== RENDER CALLED ===');
            document.getElementById('loading').classList.add('hidden');

            if (!currentLeague) {
                console.log('No current league');
                // If we expected a league but didn't find it, show the not found screen
                if (expectedLeagueSlug) {
                    console.log('Expected league slug:', expectedLeagueSlug, '- showing not found screen');
                    showLeagueNotFound(expectedLeagueSlug);
                }
                return;
            }

            console.log('Rendering for league:', currentLeague.name);

            // League found successfully - save to localStorage
            localStorage.setItem('currentLeagueSlug', currentLeague.slug);

            // Hide not found screen if it was showing
            document.getElementById('leagueNotFound').classList.add('hidden');

            // Store league URL for copy function
            const shareUrl = `${window.location.origin}${window.location.pathname}?league=${currentLeague.slug}`;
            document.getElementById('shareUrl').textContent = shareUrl;

            // Render league name in header
            renderLeagueName();

            // Check if completion celebration was already shown for this league
            if (localStorage.getItem(`completionCelebration-${currentLeague.id}`) === 'true') {
                hasShownCompletionCelebration = true;
            }

            // Check if user has set their team name
            const userPrediction = allPredictions.find(p => p.userId === currentUserId);

            if (!userPrediction) {
                // Show team name entry - don't show leaderboard yet
                document.getElementById('teamNameEntry').classList.remove('hidden');
                document.getElementById('teamNameForm').onsubmit = handleTeamNameSubmit;

                // Hide leaderboard on team entry screen
                const leaderboardSection = document.getElementById('leaderboardSection');
                if (leaderboardSection) {
                    leaderboardSection.classList.add('hidden');
                }
            } else {
                currentTeamName = userPrediction.teamName;
                isManager = userPrediction.isManager === true;

                // Show the intro replay button for returning users
                document.getElementById('introReplayBtn').classList.remove('hidden');

                // Update tab labels with team name
                const adminTab = document.getElementById('adminPredictionsTab');
                const userTab = document.getElementById('userPredictionsTab');
                if (adminTab) adminTab.innerHTML = `Team ${currentTeamName}`;
                if (userTab) userTab.innerHTML = `Team ${currentTeamName}`;

                // Show admin panel for creator
                if (isLeagueCreator) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    renderAdminControls();
                } else {
                    // Show user panel for non-admin users
                    document.getElementById('userPanel').classList.remove('hidden');
                    renderUserTabs(); // Dynamically render tabs based on manager status
                }

                // Render all content but preserve current tab
                renderPredictionsForm();
                renderParticipants();

                // Restore the correct tab view (preserve current tab on re-renders)
                // The switchTab/switchUserTab functions handle showing leaderboard on Scores tab
                if (isLeagueCreator) {
                    switchTab(currentTab);
                } else {
                    switchUserTab(currentTab);
                }
            }

            // Show all predictions if admin enabled it (defaults to false)
            const showAllPredictions = currentLeague.showAllPredictions === true;
            console.log('Show All Predictions:', showAllPredictions);
            if (showAllPredictions) {
                console.log('Rendering all predictions section...');
                renderAllPredictions();
            } else {
                console.log('Hiding all predictions section...');
                // Hide the section if toggle is off
                document.getElementById('allPredictionsSection').classList.add('hidden');
            }
        }

        // Handle team name submission
        async function handleTeamNameSubmit(e) {
            e.preventDefault();

            const teamName = document.getElementById('teamNameInput').value.trim();

            // Validate length (3-15 characters)
            if (teamName.length < 3 || teamName.length > 15) {
                alert('Team name must be 3-15 characters.');
                return;
            }

            // Check if team name already exists (case-insensitive)
            const teamNameExists = allPredictions.some(p =>
                p.teamName.toLowerCase() === teamName.toLowerCase()
            );

            if (teamNameExists) {
                alert('This team name is already taken. Please choose a different name.');
                return;
            }

            currentTeamName = teamName;

            // Generate UUID for prediction
            const predictionId = crypto.randomUUID();
            const gameId = window.GAME_ID || 'lx';

            // Create initial prediction entry
            await db.transact([
                db.tx.predictions[predictionId].update({
                    gameId: gameId,
                    leagueId: currentLeague.id,
                    userId: currentUserId,
                    teamName: teamName,
                    submittedAt: Date.now(),
                    score: 0,
                    tiebreakDiff: 0,
                    isManager: false
                })
            ]);

            // Hide team name entry
            document.getElementById('teamNameEntry').classList.add('hidden');

            // Show celebratory intro overlay
            showIntroOverlay(teamName);

            // Show the intro replay button in header
            document.getElementById('introReplayBtn').classList.remove('hidden');
        }

        // ========== TEAM NAME EDITING ==========
        // openTeamNameModal - now provided by window.openTeamNameModal from modules
        // closeTeamNameModal - now provided by window.closeTeamNameModal from modules
        // updateTeamNameCharCount - now provided by window.updateTeamNameCharCount from modules
        // handleTeamNameChange - now in ui/teamNameModal.ts

        // switchTab - now provided by window.switchTab from modules (ui/tabs.ts)
        // switchUserTab - now provided by window.switchUserTab from modules
        // renderUserTabs - now provided by window.renderUserTabs from modules
        // updateScoresTabNotification - now provided by window.updateScoresTabNotification from modules
        // clearScoresNotification - now provided by window.clearScoresNotification from modules
        // renderLeaderboard - now provided by window.renderLeaderboard from modules

        // recalculateAllScores - now provided by window.recalculateAllScores from modules
        // renderAnswerDetails - now in src/ui/leaderboard.ts
        // renderParticipants - now provided by window.renderParticipants from modules
        // copyParticipantLink - now provided by window.copyParticipantLink from modules
        // toggleManager - now provided by window.toggleManager from modules
        // openDeleteModal - now provided by window.openDeleteModal from modules
        // closeDeleteModal - now provided by window.closeDeleteModal from modules
        // confirmDeleteTeam - now provided by window.confirmDeleteTeam from modules

        // renderLeagueName - now provided by window.renderLeagueName from modules
        // countAnsweredQuestions - now in src/components/helpers.ts
        // renderAllPredictions - now provided by window.renderAllPredictions from modules

        // Start the app after Vite module is ready (includes team picker)
        window.addEventListener('DOMContentLoaded', async () => {
            // Wait for Vite app initialization (team picker, theme, etc.)
            if (window.waitForAppReady) {
                await window.waitForAppReady();
            }
            initApp();
        });
    </script>
</body>
</html>
