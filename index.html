<!-- index.html -->

<!DOCTYPE html>
<html lang="en" data-theme="seahawks">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark only">
    <title>Super Bowl Prediction Game</title>

    <!-- Favicon - Seahawks themed -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='80'>üèà</text></svg>">
    <link rel="apple-touch-icon" href="favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { init } from 'https://cdn.jsdelivr.net/npm/@instantdb/core/+esm';
        window.InstantDBInit = init;
    </script>
    <script>
        // Configure Tailwind with official Seattle Seahawks theme colors
        // Navy: #00203B, Neon Green: #33F200, Grey: #9DA2A3, White: #FFFFFF
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'seahawks-navy': '#00203B',
                        'seahawks-green': '#33F200',
                        'seahawks-grey': '#9DA2A3',
                        'seahawks-light': '#C4C4C4',
                    }
                }
            },
            daisyui: {
                themes: [
                    {
                        seahawks: {
                            "primary": "#33F200",
                            "primary-content": "#00203B",
                            "secondary": "#9DA2A3",
                            "secondary-content": "#00203B",
                            "accent": "#33F200",
                            "accent-content": "#00203B",
                            "neutral": "#002a4a",
                            "neutral-content": "#ffffff",
                            "base-100": "#00203B",
                            "base-200": "#001a30",
                            "base-300": "#001525",
                            "base-content": "#ffffff",
                            "success": "#33F200",
                            "success-content": "#00203B",
                            "error": "#ff6b6b",
                            "error-content": "#ffffff",
                            "info": "#60a5fa",
                            "info-content": "#00203B",
                            "warning": "#fbbf24",
                            "warning-content": "#00203B",
                        },
                    },
                ],
            },
        }
    </script>
    <style>
        /* Seattle Seahawks Dark Theme - Optimized for Elderly Users */
        /* Colors: Navy #00203B, Green #33F200, Grey #9DA2A3, White #FFFFFF */

        /* Force dark color scheme for all browsers (including Android) - ignore user preferences */
        :root,
        html {
            color-scheme: dark only;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 18px;
            line-height: 1.6;
        }

        /* Radio option styling - large and tappable */
        .radio-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            margin: 10px 0;
            background-color: #002a4a;
            border: 2px solid #9DA2A3;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
        }

        .radio-option:hover {
            background-color: #003355;
            border-color: #33F200;
        }

        .radio-option:has(input:checked) {
            background-color: #003355;
            border-color: #33F200;
            box-shadow: 0 0 0 3px rgba(51, 242, 0, 0.3);
        }

        .radio-option input[type="radio"] {
            width: 28px;
            height: 28px;
            accent-color: #33F200;
            cursor: pointer;
            flex-shrink: 0;
        }

        .radio-option span {
            font-size: 18px;
            font-weight: 500;
            color: #FFFFFF;
        }

        /* Question card styling - dark theme */
        .question-card {
            background: #002a4a;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #9DA2A3;
        }

        /* Closed submissions styling */
        .closed-banner {
            background: linear-gradient(135deg, #1a1520 0%, #2d1f2d 100%);
            border: 2px solid #9DA2A3;
            border-radius: 12px;
            padding: 16px 20px;
            color: #C4C4C4;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 16px;
        }

        .submissions-closed {
            opacity: 0.7;
            pointer-events: none;
        }

        .submissions-closed .question-card {
            background: #001a30;
            border-color: #5a5a5a;
        }

        .submissions-closed .radio-option {
            background-color: #001a30;
            border-color: #5a5a5a;
            cursor: default;
        }

        .submissions-closed input[type="number"] {
            background: #001a30 !important;
            border-color: #5a5a5a !important;
            cursor: default;
        }

        .question-card label {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        /* Collapsible answers - improved readability */
        .collapsible-answers {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            opacity: 0.7;
        }

        .collapsible-answers.active {
            max-height: 3000px;
            transition: max-height 0.5s ease-in;
        }

        /* Show/Hide answers toggle button - reduced contrast */
        .btn.btn-ghost.btn-sm {
            opacity: 0.65;
            transition: opacity 0.2s ease;
        }

        .btn.btn-ghost.btn-sm:hover {
            opacity: 1;
        }

        .answer-item {
            padding: 16px 20px !important;
            margin: 8px 0 !important;
            background-color: #00203B !important;
            border-radius: 10px !important;
            font-size: 18px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            color: #A5ACAF !important;
            border: 1px solid #6B7280 !important;
            font-weight: 400 !important;
        }

        .answer-item span {
            color: #A5ACAF !important;
        }

        .answer-item.correct {
            background-color: #002418 !important;
            border: 1px solid #4A9D2A !important;
            border-left: 4px solid #4A9D2A !important;
        }

        .answer-item.correct span {
            color: #6BBE42 !important;
        }

        .answer-item.incorrect {
            background-color: #250808 !important;
            border: 1px solid #B85454 !important;
            border-left: 4px solid #B85454 !important;
        }

        .answer-item.incorrect span {
            color: #CC8888 !important;
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* Number input styling - dark theme */
        input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            font-size: 20px;
            border: 2px solid #9DA2A3;
            border-radius: 12px;
            background: #002a4a;
            color: #FFFFFF;
            transition: all 0.2s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #33F200;
            box-shadow: 0 0 0 3px rgba(51, 242, 0, 0.3);
            background: #003355;
        }

        input[type="number"]::placeholder {
            color: #9DA2A3;
        }

        /* Text inputs - dark theme */
        input[type="text"] {
            background: #002a4a !important;
            color: #FFFFFF !important;
            border-color: #9DA2A3 !important;
        }

        input[type="text"]:focus {
            border-color: #33F200 !important;
            box-shadow: 0 0 0 3px rgba(51, 242, 0, 0.3) !important;
        }

        /* App header - Seahawks gradient - MUST be opaque for sticky */
        .app-header {
            position: relative;
            background: #00203B !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Ctext x='20' y='40' font-family='Arial, sans-serif' font-size='22' font-weight='900' fill='%2333F200' fill-opacity='0.18'%3E12s%3C/text%3E%3Ctext x='120' y='90' font-family='Arial, sans-serif' font-size='24' fill='%23FFFFFF' fill-opacity='0.14'%3Eüèà%3C/text%3E%3Ctext x='60' y='140' font-family='Arial, sans-serif' font-size='20' font-weight='900' fill='%2333F200' fill-opacity='0.15'%3E12s%3C/text%3E%3Ctext x='150' y='180' font-family='Arial, sans-serif' font-size='20' fill='%23FFFFFF' fill-opacity='0.14'%3Eüèà%3C/text%3E%3Ctext x='10' y='190' font-family='Arial, sans-serif' font-size='18' fill='%23FFFFFF' fill-opacity='0.12'%3Eüèà%3C/text%3E%3C/svg%3E") !important;
            color: #FFFFFF;
            padding: 16px;
            padding-bottom: 20px;
            text-align: center;
            border-bottom: none;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .header-text {
            text-align: right;
        }

        .header-text h1 {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
            color: #33F200;
            letter-spacing: 2px;
        }

        .header-text h2 {
            font-size: 14px;
            font-weight: 600;
            color: #C4C4C4;
            margin: 0;
            letter-spacing: 1px;
        }

        .header-logo {
            height: 80px;
            width: auto;
            filter: drop-shadow(0 2px 8px rgba(51, 242, 0, 0.3));
        }

        .header-teams {
            text-align: left;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .header-teams .team-name {
            font-size: 14px;
            font-weight: 700;
            color: #FFFFFF;
        }

        .header-teams .vs {
            font-size: 11px;
            color: #33F200;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                gap: 4px;
            }
            .header-logo {
                height: 70px;
            }
            .matchup-text {
                font-size: 12px;
            }
            .title-text {
                font-size: 18px;
            }
        }

        /* Cards - better contrast */
        .card {
            background: #002a4a !important;
            border: 1px solid #9DA2A3 !important;
        }

        .card-title {
            color: #33F200 !important;
            font-size: 22px !important;
        }

        .card-body p {
            color: #C4C4C4 !important;
            font-size: 16px !important;
        }

        /* Badges - high contrast */
        .badge-primary {
            background-color: #33F200 !important;
            color: #00203B !important;
            font-weight: 600 !important;
        }

        .badge-success {
            background-color: #33F200 !important;
            color: #00203B !important;
        }

        .badge-error {
            background-color: #ff6b6b !important;
            color: #FFFFFF !important;
        }

        /* Buttons - large and readable */
        .btn {
            font-size: 18px !important;
            font-weight: 600 !important;
            min-height: 56px !important;
        }

        .btn-primary {
            background-color: #33F200 !important;
            color: #00203B !important;
            border: none !important;
        }

        .btn-primary:hover {
            background-color: #2ad600 !important;
        }

        /* Tabs - high contrast */
        .tabs {
            background: #001a30 !important;
        }

        .tab {
            color: #C4C4C4 !important;
            font-size: 16px !important;
            font-weight: 500 !important;
        }

        .tab-active, .tab.tab-active {
            background-color: #33F200 !important;
            color: #00203B !important;
            font-weight: 700 !important;
        }

        /* Results tab styling - muted coral/salmon */
        .tab.tab-results {
            background-color: rgba(229, 115, 115, 0.15) !important;
            color: #e57373 !important;
        }
        .tab-active.tab-results, .tab.tab-active.tab-results {
            background-color: #e57373 !important;
            color: #FFFFFF !important;
        }

        /* Alerts - better visibility */
        .alert {
            font-size: 16px !important;
            padding: 16px 20px !important;
        }

        .alert-info {
            background-color: rgba(96, 165, 250, 0.2) !important;
            border: 1px solid #60a5fa !important;
            color: #FFFFFF !important;
        }

        .alert-success {
            background-color: rgba(51, 242, 0, 0.15) !important;
            border: 1px solid #33F200 !important;
            color: #FFFFFF !important;
        }

        /* Progress bars */
        .progress-primary {
            background-color: #002a4a;
        }

        .progress-primary::-webkit-progress-value {
            background-color: #33F200;
        }

        /* Table styling for All Predictions */
        table, .table {
            font-size: 14px !important;
            background-color: #00203B !important;
        }

        table th, .table th {
            background-color: #33F200 !important;
            color: #00203B !important;
            font-weight: 700 !important;
            padding: 12px 8px !important;
            font-size: 13px !important;
        }

        table td, .table td {
            background-color: #002a4a !important;
            color: #FFFFFF !important;
            padding: 10px 8px !important;
            border-color: #9DA2A3 !important;
            font-size: 14px !important;
        }

        table thead, .table thead {
            background-color: #33F200 !important;
        }

        table tbody tr, .table tbody tr {
            background-color: #002a4a !important;
        }

        /* Ensure good readability on mobile */
        @media (max-width: 640px) {
            .app-header h1 {
                font-size: 22px;
            }

            .app-header h2 {
                font-size: 16px;
            }

            body {
                font-size: 16px;
            }

            .radio-option span {
                font-size: 16px;
            }

            .question-card label {
                font-size: 16px;
            }
        }

        /* ========== FUN UI ENHANCEMENTS ========== */

        /* Background styling with 12s and footballs pattern */
        body {
            background-color: #00203B;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Ctext x='20' y='40' font-family='Arial, sans-serif' font-size='22' font-weight='900' fill='%2333F200' fill-opacity='0.18'%3E12s%3C/text%3E%3Ctext x='120' y='90' font-family='Arial, sans-serif' font-size='24' fill='%23FFFFFF' fill-opacity='0.14'%3Eüèà%3C/text%3E%3Ctext x='60' y='140' font-family='Arial, sans-serif' font-size='20' font-weight='900' fill='%2333F200' fill-opacity='0.15'%3E12s%3C/text%3E%3Ctext x='150' y='180' font-family='Arial, sans-serif' font-size='20' fill='%23FFFFFF' fill-opacity='0.14'%3Eüèà%3C/text%3E%3Ctext x='10' y='190' font-family='Arial, sans-serif' font-size='18' fill='%23FFFFFF' fill-opacity='0.12'%3Eüèà%3C/text%3E%3C/svg%3E");
            background-attachment: fixed;
        }

        /* 12th Man badge reference */

        /* Intro overlay styling */
        .intro-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 32, 59, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            overflow: hidden;
        }

        .intro-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .intro-image {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center top;
            opacity: 0;
            transition: all 0.15s ease-in-out;
            filter: brightness(0.5);
            transform-origin: center center;
        }

        /* Desktop: constrain intro image to narrow centered column */
        @media (min-width: 768px) {
            .intro-image {
                left: 50%;
                transform: translateX(-50%);
                width: 480px;
                max-width: 100%;
                border-radius: 16px;
                top: 120px;
                height: calc(100% - 140px);
                object-fit: contain;
                box-shadow: 0 0 60px rgba(51, 242, 0, 0.2);
            }
        }

        .intro-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.8);
            padding-top: 16px;
            background: linear-gradient(to bottom, rgba(0, 32, 59, 0.95) 0%, rgba(0, 32, 59, 0.7) 70%, transparent 100%);
            width: 100%;
            padding-bottom: 20px;
        }

        @keyframes imageReveal {
            0% {
                opacity: 0;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .intro-football-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        .intro-football {
            font-size: 32px;
            animation: footballBounceStop 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            position: relative;
            z-index: 10;
        }

        .intro-football-shadow {
            width: 30px;
            height: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            filter: blur(3px);
            margin-top: 4px;
            animation: shadowPulse 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .intro-title {
            font-size: 28px;
            font-weight: 700;
            color: #33F200;
            margin-top: 8px;
            opacity: 0;
            animation: slideUp 0.5s ease-out 0.3s forwards;
        }

        .intro-team-name {
            font-size: 20px;
            color: #FFFFFF;
            margin-top: 6px;
            opacity: 0;
            animation: slideUp 0.5s ease-out 0.5s forwards;
        }

        @keyframes footballBounceStop {
            0% {
                transform: translateX(-80px) translateY(-120px) rotate(-30deg);
                opacity: 0;
            }
            15% {
                transform: translateX(-50px) translateY(80px) rotate(0deg);
                opacity: 1;
            }
            25% {
                transform: translateX(-30px) translateY(30px) rotate(180deg);
            }
            35% {
                transform: translateX(-10px) translateY(80px) rotate(360deg);
            }
            42% {
                transform: translateX(5px) translateY(55px) rotate(450deg);
            }
            50% {
                transform: translateX(20px) translateY(80px) rotate(540deg);
            }
            55% {
                transform: translateX(30px) translateY(70px) rotate(580deg);
            }
            60% {
                transform: translateX(40px) translateY(80px) rotate(600deg);
            }
            80% {
                transform: translateX(60px) translateY(80px) rotate(720deg);
            }
            100% {
                transform: translateX(60px) translateY(80px) rotate(720deg);
                opacity: 1;
            }
        }

        @keyframes shadowPulse {
            0% {
                opacity: 0;
                transform: translateX(-80px) translateY(80px) scale(0);
            }
            15% {
                opacity: 0.5;
                transform: translateX(-50px) translateY(80px) scale(1);
            }
            25% {
                opacity: 0.2;
                transform: translateX(-30px) translateY(80px) scale(0.5);
            }
            35% {
                opacity: 0.5;
                transform: translateX(-10px) translateY(80px) scale(1);
            }
            42% {
                opacity: 0.3;
                transform: translateX(5px) translateY(80px) scale(0.6);
            }
            50% {
                opacity: 0.5;
                transform: translateX(20px) translateY(80px) scale(1);
            }
            55% {
                opacity: 0.4;
                transform: translateX(30px) translateY(80px) scale(0.8);
            }
            60% {
                opacity: 0.5;
                transform: translateX(40px) translateY(80px) scale(1);
            }
            80% {
                opacity: 0.5;
                transform: translateX(60px) translateY(80px) scale(1);
            }
            100% {
                opacity: 0.5;
                transform: translateX(60px) translateY(80px) scale(1);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Scores tab notification badge */
        .tab-scores-notify {
            position: relative;
        }

        .tab-scores-notify::after {
            content: 'üèà';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #33F200;
            color: #00203B;
            font-size: 16px;
            font-weight: 700;
            padding: 4px 6px;
            border-radius: 50%;
            animation: pulseGlow 2s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(51, 242, 0, 0.6);
        }

        @keyframes pulseGlow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 8px rgba(51, 242, 0, 0.6);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 16px rgba(51, 242, 0, 0.9);
            }
        }

        /* Trophy bounce animation */
        .trophy-bounce {
            display: inline-block;
            animation: trophyBounce 0.5s ease-out;
        }

        @keyframes trophyBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Winner shimmer border effect */
        .winner-shimmer {
            position: relative;
            overflow: hidden;
        }

        .winner-shimmer::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(
                90deg,
                #FFD700 0%,
                #FFF8DC 25%,
                #FFD700 50%,
                #FFF8DC 75%,
                #FFD700 100%
            );
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
            border-radius: inherit;
            z-index: -1;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Podium place styling */
        .place-gold {
            border: 3px solid #FFD700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .place-silver {
            border: 3px solid #C0C0C0 !important;
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.2);
        }

        .place-bronze {
            border: 3px solid #CD7F32 !important;
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.2);
        }

        /* Toast notification styling */
        .toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #003320 0%, #002a4a 100%);
            border: 2px solid #33F200;
            border-radius: 16px;
            padding: 16px 24px;
            color: #FFFFFF;
            font-size: 18px;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transition: all 0.4s ease-out;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 90%;
        }

        .toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Sound toggle button */
        .sound-toggle {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(51, 242, 0, 0.1);
            border: 2px solid rgba(51, 242, 0, 0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .sound-toggle:hover {
            background: rgba(51, 242, 0, 0.2);
            border-color: #33F200;
        }

        .sound-toggle:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Intro replay button */
        .intro-replay-btn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(51, 242, 0, 0.1);
            border: 2px solid rgba(51, 242, 0, 0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .intro-replay-btn:hover {
            background: rgba(51, 242, 0, 0.2);
            border-color: #33F200;
        }

        .intro-replay-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* New header layout */
        .header-matchup {
            width: 100%;
            text-align: center;
            margin-bottom: 4px;
        }

        .matchup-text {
            font-size: 20px;
            font-weight: 800;
            color: #33F200;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(51, 242, 0, 0.4);
        }

        .header-title {
            width: 100%;
            text-align: center;
            margin-top: 4px;
        }

        .title-text {
            font-size: 14px;
            font-weight: 600;
            color: #C4C4C4;
            letter-spacing: 1px;
        }

        /* Progress bar */
        .progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0, 32, 59, 0.8);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #33F200 0%, #2ad600 50%, #33F200 100%);
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(51, 242, 0, 0.5);
        }

        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .intro-football {
                animation: footballBounce 0.6s ease-out !important;
            }

            .intro-title,
            .intro-team-name,
            .trophy-bounce {
                animation: none !important;
                opacity: 1 !important;
                transform: none !important;
            }

            .winner-shimmer::before {
                animation: none !important;
            }

            .toast-notification {
                transition: opacity 0.2s ease-out !important;
            }

            .toast-notification.show {
                transform: translateX(-50%) translateY(0);
            }

            .league-name-header {
                animation: none !important;
            }

            .tab-scores-notify::after {
                animation: none !important;
                box-shadow: 0 0 8px rgba(51, 242, 0, 0.6) !important;
            }
        }

        /* ========== FEATURE 1: Correct Answer Indicators ========== */
        .correct-answer-indicator {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .correct-answer-indicator.correct {
            background: rgba(51, 242, 0, 0.15);
            border: 2px solid #33F200;
            color: #33F200;
        }

        .correct-answer-indicator.incorrect {
            background: rgba(255, 107, 107, 0.15);
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
        }

        .correct-answer-indicator .indicator-icon {
            font-size: 18px;
            font-weight: 700;
        }

        .user-answer-correct {
            background-color: #003320 !important;
            border-color: #33F200 !important;
            box-shadow: 0 0 0 3px rgba(51, 242, 0, 0.3) !important;
        }

        .user-answer-incorrect {
            background-color: #330a0a !important;
            border-color: #ff6b6b !important;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3) !important;
        }

        /* ========== FEATURE 2: Team Name Edit ========== */
        .team-name-edit-btn {
            background: rgba(0, 32, 59, 0.3);
            border: 1px solid rgba(0, 32, 59, 0.5);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            color: #00203B;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
            font-weight: 600;
        }

        .team-name-edit-btn:hover {
            background: rgba(0, 32, 59, 0.5);
            border-color: #00203B;
        }

        .char-count {
            font-size: 13px;
            margin-top: 8px;
            transition: color 0.2s ease;
        }

        .char-count-valid {
            color: #33F200;
        }

        .char-count-warning {
            color: #fbbf24;
        }

        .char-count-error {
            color: #ff6b6b;
        }

        /* ========== FEATURE 3: League Name Display (Header) ========== */
        .league-name-header {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: linear-gradient(
                90deg,
                #33F200 0%,
                #66FF33 50%,
                #33F200 100%
            );
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: leagueShimmer 3s ease-in-out infinite;
            padding: 4px 12px;
            border: 1px solid rgba(51, 242, 0, 0.3);
            border-radius: 12px;
            display: inline-block;
        }

        @keyframes leagueShimmer {
            0%, 100% {
                background-position: 0% 0%;
            }
            50% {
                background-position: 100% 0%;
            }
        }

        /* ========== FEATURE 4: Delete Team Button ========== */
        .delete-team-btn {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.4);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 600;
            color: #ff6b6b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-team-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }

        .delete-confirm-modal .modal-box {
            background: linear-gradient(135deg, #1a0f0f 0%, #2d1515 100%);
            border: 2px solid #ff6b6b;
        }

        .btn-delete {
            background-color: #ff6b6b !important;
            color: #FFFFFF !important;
            border: none !important;
        }

        .btn-delete:hover {
            background-color: #ff5252 !important;
        }
    </style>
</head>
<body data-theme="seahawks" class="bg-base-100 min-h-screen">
    <!-- Header -->
    <div class="app-header sticky top-0 z-50 shadow-lg" style="background: linear-gradient(135deg, #00203B 0%, #002a4a 50%, #00203B 100%); background-color: #00203B;">
        <button id="soundToggle" class="sound-toggle" onclick="SoundManager.toggle()" title="Toggle sound">
            üîá
        </button>
        <button id="introReplayBtn" class="intro-replay-btn hidden" onclick="replayIntro()" title="See intro again">
            üì∑
        </button>
        <div class="header-content">
            <div class="header-matchup">
                <span class="matchup-text">Seahawks vs Pats</span>
            </div>
            <img src="images/superbowl-lx-logo.svg" alt="Super Bowl LX" class="header-logo" />
            <div class="header-title">
                <span class="title-text">Predictions</span>
            </div>
            <div id="leagueNameHeader" class="hidden" style="margin-top: 6px;">
                <span class="league-name-header"></span>
            </div>
        </div>
        <!-- Progress bar below header -->
        <div id="progressBarContainer" class="progress-bar-container hidden">
            <div id="progressBar" class="progress-bar"></div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-2xl">
        <!-- Loading State -->
        <div id="loading" class="flex justify-center items-center min-h-screen">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>

        <!-- League Creation -->
        <div id="leagueCreation" class="hidden">
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-primary">Create Your League</h2>
                    <p class="text-base-content/80">Enter a name for your prediction league. You'll get a shareable link to invite others!</p>

                    <form id="leagueForm" class="space-y-4 mt-4">
                        <div class="form-control">
                            <label class="label" for="leagueName">
                                <span class="label-text text-base-content">League Name</span>
                            </label>
                            <input type="text" id="leagueName" required placeholder="e.g., Good Vibes"
                                class="input input-bordered input-primary w-full text-lg" />
                        </div>
                        <button type="submit" class="btn btn-primary w-full btn-lg">Create League</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- League URL stored for copy function -->
        <div id="shareUrl" class="hidden"></div>

        <!-- Team Name Entry -->
        <div id="teamNameEntry" class="hidden">
            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl text-primary">Enter Your Team Name</h2>
                    <p class="text-base-content/80">Choose a unique name for your team in this league.</p>

                    <form id="teamNameForm" class="space-y-4 mt-4">
                        <div class="form-control">
                            <label class="label" for="teamNameInput">
                                <span class="label-text text-base-content">Your Team Name</span>
                            </label>
                            <input type="text" id="teamNameInput" required placeholder="e.g., John's Picks"
                                minlength="3" maxlength="15"
                                class="input input-bordered input-primary w-full text-lg" />
                        </div>
                        <button type="submit" class="btn btn-primary w-full btn-lg">Continue</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Intro Overlay (shown after team registration) -->
        <div id="introOverlay" class="intro-overlay hidden">
            <img id="introImage" class="intro-image" src="" alt="Seahawks" />
            <div class="intro-content">
                <div class="intro-football-container">
                    <div class="intro-football">üèà</div>
                    <div class="intro-football-shadow"></div>
                </div>
                <div class="intro-title">Welcome to the Game!</div>
                <div id="introTeamName" class="intro-team-name"></div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toastNotification" class="toast-notification"></div>

        <!-- Team Name Edit Modal -->
        <dialog id="teamNameModal" class="modal">
            <div class="modal-box bg-base-200">
                <h3 class="font-bold text-lg text-primary mb-4">Edit Team Name</h3>
                <form id="teamNameEditForm" class="space-y-4">
                    <div class="form-control">
                        <label class="label" for="teamNameEditInput">
                            <span class="label-text text-base-content">New Team Name</span>
                        </label>
                        <input type="text" id="teamNameEditInput" required
                            minlength="3" maxlength="15"
                            placeholder="Enter team name"
                            class="input input-bordered input-primary w-full text-lg"
                            oninput="updateTeamNameCharCount()" />
                        <div id="teamNameCharCount" class="char-count char-count-valid">0/15 characters (min 3)</div>
                    </div>
                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" onclick="closeTeamNameModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <!-- Delete Team Confirmation Modal -->
        <dialog id="deleteTeamModal" class="modal delete-confirm-modal">
            <div class="modal-box bg-base-200" style="background: linear-gradient(135deg, #1a0f0f 0%, #2d1515 100%); border: 2px solid #ff6b6b;">
                <h3 class="font-bold text-lg mb-4" style="color: #ff6b6b;">Delete Team</h3>
                <p class="mb-2" style="color: #FFFFFF;">Are you sure you want to delete <strong id="deleteTeamName" style="color: #ff6b6b;"></strong>?</p>
                <p class="text-sm mb-4" style="color: #ff9999;">This action cannot be undone. All predictions for this team will be permanently removed.</p>
                <input type="hidden" id="deleteTeamId" value="" />
                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
                    <button type="button" class="btn btn-delete" onclick="confirmDeleteTeam()">Delete Team</button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <!-- Admin Panel (for league creator) -->
        <div id="adminPanel" class="hidden">
            <div role="tablist" class="tabs tabs-boxed bg-base-200 mb-6 sticky top-[120px] z-40 shadow-lg">
                <a role="tab" id="adminPredictionsTab" class="tab tab-active" onclick="switchTab('predictions')">My Predictions</a>
                <a role="tab" class="tab" onclick="switchTab('scores')">Scores</a>
                <a role="tab" id="adminResultsTab" class="tab tab-results" onclick="switchTab('results')">Results</a>
                <a role="tab" class="tab" onclick="switchTab('admin')">Admin</a>
            </div>

            <!-- Admin Controls Tab -->
            <div id="adminTab" class="hidden space-y-6">
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-0">
                        <button onclick="toggleGameStatus()" class="w-full p-4 flex justify-between items-center cursor-pointer" style="background: transparent; border: none;">
                            <h3 class="card-title text-primary m-0">Game Status</h3>
                            <span id="gameStatusToggleIcon" style="color: #33F200; font-size: 18px;">‚ñº</span>
                        </button>
                        <div id="gameStatusContent" class="px-4 pb-4">
                            <div id="gameStatus"></div>
                        </div>
                    </div>
                </div>

                <!-- Participants Section (collapsible) -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-0">
                        <button onclick="toggleParticipants()" class="w-full p-4 flex justify-between items-center cursor-pointer" style="background: transparent; border: none;">
                            <h3 class="card-title text-primary m-0">üë• Participants</h3>
                            <span id="participantsToggleIcon" style="color: #33F200; font-size: 18px;">‚ñ∂</span>
                        </button>
                        <div id="participantsContent" class="px-4 pb-4" style="display: none;">
                            <div id="participantsList" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Test Scoring Section (collapsible) -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-0">
                        <button onclick="toggleTestScoring()" class="w-full p-4 flex justify-between items-center cursor-pointer" style="background: transparent; border: none;">
                            <h3 class="card-title text-primary m-0">üß™ Test Scoring Logic</h3>
                            <span id="testScoringToggleIcon" style="color: #33F200; font-size: 18px;">‚ñ∂</span>
                        </button>
                        <div id="testScoringContent" class="px-4 pb-4" style="display: none;">
                            <p class="text-sm mb-4" style="color: #9DA2A3;">
                                Run automated tests to verify the scoring logic is working correctly.
                            </p>
                            <button onclick="runScoringTests()" class="btn btn-primary w-full mb-4">
                                ‚ñ∂ Run Tests
                            </button>
                            <div id="testResults"></div>
                        </div>
                    </div>
                </div>

                <!-- Recalculate Scores Section (collapsible) -->
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body p-0">
                        <button onclick="toggleRecalculateScores()" class="w-full p-4 flex justify-between items-center cursor-pointer" style="background: transparent; border: none;">
                            <h3 class="card-title text-primary m-0">üîÑ Recalculate Scores</h3>
                            <span id="recalculateScoresToggleIcon" style="color: #33F200; font-size: 18px;">‚ñ∂</span>
                        </button>
                        <div id="recalculateScoresContent" class="px-4 pb-4" style="display: none;">
                            <p class="text-sm mb-4" style="color: #9DA2A3;">
                                Recalculate scores for all participants. Useful when someone submits predictions after results have been entered.
                            </p>
                            <button onclick="recalculateAllScores()" class="btn btn-primary w-full mb-4" id="recalculateScoresBtn">
                                üîÑ Recalculate All Scores
                            </button>
                            <div id="recalculateScoresStatus"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Regular User Panel (non-admin users) -->
        <div id="userPanel" class="hidden">
            <div id="userTabs" role="tablist" class="tabs tabs-boxed bg-base-200 mb-6 sticky top-[120px] z-40 shadow-lg">
                <a role="tab" id="userPredictionsTab" class="tab tab-active" onclick="switchUserTab('predictions')">My Predictions</a>
                <a role="tab" class="tab" onclick="switchUserTab('scores')">Scores</a>
            </div>
        </div>

        <!-- Results Tab (for admins and managers) -->
        <div id="resultsTab" class="hidden">
            <div class="card shadow-xl" style="background-color: #1a0f0f; border: 2px solid #e57373;">
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span style="background: #e57373; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; text-transform: uppercase;">Admin/Manager</span>
                        <h3 class="card-title" style="color: #e57373; margin: 0;">Enter Actual Results</h3>
                    </div>
                    <p class="text-sm" style="color: #9DA2A3;">
                        Results are saved automatically as you enter them. Scores update in real-time.
                    </p>
                    <p id="resultsAutoSaveStatus" class="text-sm text-success text-center font-semibold"></p>
                    <form id="resultsForm" class="space-y-4 mt-4">
                        <!-- Results form will be generated by JS -->
                    </form>
                </div>
            </div>
        </div>

        <!-- Predictions Form -->
        <div id="predictionsSection" class="hidden">
            <div id="submissionsStatus" class="mb-4"></div>

            <div class="card bg-base-200 shadow-xl">
                <div class="card-body">
                    <p id="autoSaveStatus" class="text-sm text-success text-center font-semibold"></p>

                    <form id="predictionsForm" class="space-y-4 mt-4">
                        <!-- Questions will be generated by JS -->
                    </form>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboardSection" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-primary">üèÜ Leaderboard</h2>
            <div id="leaderboard" class="space-y-3"></div>

            <!-- All Predictions Table (only visible in Scores tab when enabled by admin) -->
            <div id="allPredictionsSection" class="hidden mt-8">
                <h2 class="text-3xl font-bold mb-6 text-primary">All Predictions</h2>
                <div class="overflow-x-auto" id="allPredictionsTable"></div>
            </div>
        </div>
    </div>

    <script>
        // InstantDB Configuration
        // APP_ID will be replaced at build time by Netlify env var
        const APP_ID = '__INSTANTDB_APP_ID__';
        let db;

        // Global state
        let currentLeague = null;
        let allPredictions = [];
        let currentUserId = null;
        let currentTeamName = null;
        let isLeagueCreator = false;
        let isManager = false;
        let currentTab = localStorage.getItem('currentTab') || 'predictions';
        let hasShownCompletionCelebration = false; // Track if completion celebration has been shown
        let previousActualResults = null;
        let hasUnviewedScoreUpdate = false;

        // ========== SOUND MANAGER ==========
        // Uses Web Audio API for synthesized sounds and Seahawks audio clips
        const SoundManager = {
            enabled: false, // Default OFF for elderly users
            audioContext: null,
            audioUrls: {
                intro: 'https://www2.seahawks.com/soundboard/audio/here-come-the-seahawks.mp3',
                random: [
                    'https://www2.seahawks.com/soundboard/audio/touchdown-seahawks.mp3',
                    'https://www2.seahawks.com/soundboard/audio/defensive-stop.mp3',
                    'https://www2.seahawks.com/soundboard/audio/are-you-kidding-me.mp3'
                ]
            },

            init() {
                // Load preference from localStorage
                const saved = localStorage.getItem('soundEnabled');
                this.enabled = saved === 'true';
                this.updateButton();

                // Check for reduced motion preference
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    this.enabled = false;
                    localStorage.setItem('soundEnabled', 'false');
                }
            },

            getContext() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return this.audioContext;
            },

            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('soundEnabled', this.enabled.toString());
                this.updateButton();

                // Play a random Seahawks sound when enabling
                if (this.enabled) {
                    this.playRandomSound();
                }
            },

            // Play an audio file from URL
            playAudio(url) {
                if (!this.enabled) return;
                try {
                    const audio = new Audio(url);
                    audio.volume = 0.7;
                    audio.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Audio not available');
                }
            },

            // Play intro sound for team registration (always plays, regardless of sound setting)
            playIntro() {
                try {
                    const audio = new Audio(this.audioUrls.intro);
                    audio.volume = 0.7;
                    audio.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Audio not available');
                }
            },

            // Play random Seahawks sound for toggle feedback
            playRandomSound() {
                const sounds = this.audioUrls.random;
                const randomIndex = Math.floor(Math.random() * sounds.length);
                this.playAudio(sounds[randomIndex]);
            },

            updateButton() {
                const btn = document.getElementById('soundToggle');
                if (btn) {
                    btn.textContent = this.enabled ? 'üîä' : 'üîá';
                    btn.title = this.enabled ? 'Sound on - click to mute' : 'Sound off - click to enable';
                }
            },

            // Simple click sound for feedback
            playClick() {
                if (!this.enabled) return;
                try {
                    const ctx = this.getContext();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.frequency.setValueAtTime(800, ctx.currentTime);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);

                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.1);
                } catch (e) {
                    console.log('Sound not available');
                }
            },

            // Triumphant chord for team registration
            playCheer() {
                if (!this.enabled) return;
                try {
                    const ctx = this.getContext();

                    // Play a triumphant chord (C major with added notes)
                    const frequencies = [261.63, 329.63, 392.00, 523.25]; // C4, E4, G4, C5
                    const duration = 0.8;

                    frequencies.forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();

                        osc.connect(gain);
                        gain.connect(ctx.destination);

                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(freq, ctx.currentTime);

                        // Stagger the start slightly for a richer sound
                        const startTime = ctx.currentTime + i * 0.05;
                        gain.gain.setValueAtTime(0, startTime);
                        gain.gain.linearRampToValueAtTime(0.15, startTime + 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);

                        osc.start(startTime);
                        osc.stop(startTime + duration);
                    });
                } catch (e) {
                    console.log('Sound not available');
                }
            },

            // Ascending fanfare for winners
            playWinner() {
                if (!this.enabled) return;
                try {
                    const ctx = this.getContext();

                    // Ascending fanfare notes
                    const notes = [
                        { freq: 392.00, time: 0 },      // G4
                        { freq: 493.88, time: 0.15 },   // B4
                        { freq: 587.33, time: 0.30 },   // D5
                        { freq: 783.99, time: 0.45 }    // G5
                    ];

                    notes.forEach(note => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();

                        osc.connect(gain);
                        gain.connect(ctx.destination);

                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(note.freq, ctx.currentTime + note.time);

                        gain.gain.setValueAtTime(0, ctx.currentTime + note.time);
                        gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + note.time + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + note.time + 0.3);

                        osc.start(ctx.currentTime + note.time);
                        osc.stop(ctx.currentTime + note.time + 0.35);
                    });

                    // Add a final sustain chord
                    setTimeout(() => {
                        const chordFreqs = [392.00, 493.88, 587.33]; // G major
                        chordFreqs.forEach(freq => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();

                            osc.connect(gain);
                            gain.connect(ctx.destination);

                            osc.type = 'sine';
                            osc.frequency.setValueAtTime(freq, ctx.currentTime);

                            gain.gain.setValueAtTime(0.1, ctx.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);

                            osc.start(ctx.currentTime);
                            osc.stop(ctx.currentTime + 1);
                        });
                    }, 600);
                } catch (e) {
                    console.log('Sound not available');
                }
            },

            // Small success sound for completion
            playSuccess() {
                if (!this.enabled) return;
                try {
                    const ctx = this.getContext();

                    // Two-note success jingle
                    const notes = [
                        { freq: 523.25, time: 0 },    // C5
                        { freq: 659.25, time: 0.1 }   // E5
                    ];

                    notes.forEach(note => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();

                        osc.connect(gain);
                        gain.connect(ctx.destination);

                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(note.freq, ctx.currentTime + note.time);

                        gain.gain.setValueAtTime(0.15, ctx.currentTime + note.time);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + note.time + 0.2);

                        osc.start(ctx.currentTime + note.time);
                        osc.stop(ctx.currentTime + note.time + 0.25);
                    });
                } catch (e) {
                    console.log('Sound not available');
                }
            }
        };

        // ========== CELEBRATION FUNCTIONS ==========

        // Show intro overlay after team registration
        // Seahawks intro images (bundled locally)
        const introImages = [
            'images/seahawks-1.png',
            'images/seahawks-2.jpg',
            'images/seahawks-3.png',
            'images/seahawks-4.jpg',
            'images/seahawks-5.jpg',
            'images/seahawks-6.jpg',
            'images/seahawks-7.png'
        ];

        // Shuffle array helper
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showIntroOverlay(teamName) {
            const overlay = document.getElementById('introOverlay');
            const teamNameEl = document.getElementById('introTeamName');
            const introImage = document.getElementById('introImage');

            // ===== CONFIGURATION =====
            const IMAGE_DURATION = 2000; // How long each image shows (in milliseconds)
            const TRANSITION_SPEED = 150; // Transition animation speed (in milliseconds)
            // =========================

            // Pick 5 random images (shuffled)
            const slideshowImages = shuffleArray(introImages).slice(0, 5);
            let currentIndex = 0;

            // Preload images for smooth slideshow
            slideshowImages.forEach(src => {
                const img = new Image();
                img.src = src;
            });

            // Start with first image
            introImage.src = slideshowImages[0];
            introImage.style.opacity = '1';

            teamNameEl.textContent = `Team: ${teamName}`;
            overlay.classList.remove('hidden');

            // Calculate total duration based on image count and duration
            const totalDuration = slideshowImages.length * IMAGE_DURATION;

            // Reset football and shadow animations for replay
            const footballEl = overlay.querySelector('.intro-football');
            const shadowEl = overlay.querySelector('.intro-football-shadow');
            if (footballEl) {
                footballEl.style.animation = 'none';
                void footballEl.offsetWidth; // Force reflow
                footballEl.style.animation = 'footballBounceStop 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
            }
            if (shadowEl) {
                shadowEl.style.animation = 'none';
                void shadowEl.offsetWidth; // Force reflow
                shadowEl.style.animation = 'shadowPulse 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
            }

            // Play intro sound
            const introAudio = new Audio(SoundManager.audioUrls.intro);
            introAudio.volume = 0.7;
            introAudio.play().catch(e => console.log('Audio play failed:', e));

            // Cool transition effects to randomly apply
            const transitions = [
                // Fade with zoom in
                { out: (img) => { img.style.opacity = '0'; img.style.transform = 'scale(1.1)'; },
                  in: (img) => { img.style.opacity = '1'; img.style.transform = 'scale(1)'; } },
                // Fade with zoom out
                { out: (img) => { img.style.opacity = '0'; img.style.transform = 'scale(0.9)'; },
                  in: (img) => { img.style.opacity = '1'; img.style.transform = 'scale(1)'; } },
                // Slide from right
                { out: (img) => { img.style.opacity = '0'; img.style.transform = 'translateX(-30px)'; },
                  in: (img) => { img.style.opacity = '1'; img.style.transform = 'translateX(0)'; } },
                // Slide from left
                { out: (img) => { img.style.opacity = '0'; img.style.transform = 'translateX(30px)'; },
                  in: (img) => { img.style.opacity = '1'; img.style.transform = 'translateX(0)'; } },
                // Fade with slight rotation
                { out: (img) => { img.style.opacity = '0'; img.style.transform = 'rotate(2deg) scale(0.95)'; },
                  in: (img) => { img.style.opacity = '1'; img.style.transform = 'rotate(0deg) scale(1)'; } }
            ];

            // Start slideshow with random transitions
            const slideshowInterval = setInterval(() => {
                currentIndex++;
                if (currentIndex < slideshowImages.length) {
                    // Pick a random transition
                    const transition = transitions[Math.floor(Math.random() * transitions.length)];

                    // Apply exit transition
                    transition.out(introImage);

                    setTimeout(() => {
                        introImage.src = slideshowImages[currentIndex];
                        // Apply enter transition
                        transition.in(introImage);
                    }, TRANSITION_SPEED);
                }
            }, IMAGE_DURATION);

            // Auto-dismiss after slideshow completes
            setTimeout(() => {
                clearInterval(slideshowInterval);
                overlay.classList.add('fade-out');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('fade-out');
                    // Clear image src to free memory
                    introImage.src = '';
                    introImage.style.opacity = '';
                    introImage.style.transform = '';
                }, 500);
            }, totalDuration);

            // Trigger confetti
            if (typeof confetti === 'function' && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#33F200', '#00203B', '#FFFFFF', '#FFD700'],
                    disableForReducedMotion: true
                });
            }
        }

        // Replay intro from header button
        function replayIntro() {
            if (currentTeamName) {
                showIntroOverlay(currentTeamName);
            }
        }

        // Update progress bar based on answered questions
        function updateProgressBar() {
            const container = document.getElementById('progressBarContainer');
            const bar = document.getElementById('progressBar');
            const form = document.getElementById('predictionsForm');

            if (!form || !container || !bar) return;

            const formData = new FormData(form);
            let answeredCount = 0;

            questions.forEach(q => {
                const value = formData.get(q.id);
                if (value !== null && value !== '') {
                    answeredCount++;
                }
            });

            const percentage = (answeredCount / questions.length) * 100;
            bar.style.width = percentage + '%';

            // Show container if any progress
            if (answeredCount > 0) {
                container.classList.remove('hidden');
            }
        }

        // Trigger winner celebration (confetti + sound)
        let hasTriggeredWinnerCelebration = false;
        function triggerWinnerCelebration() {
            if (hasTriggeredWinnerCelebration) return;
            hasTriggeredWinnerCelebration = true;

            // Play winner sound
            SoundManager.playWinner();

            // Confetti burst with Seahawks colors
            if (typeof confetti === 'function' && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                // First burst
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#33F200', '#00203B', '#FFFFFF', '#FFD700'],
                    disableForReducedMotion: true
                });

                // Second burst after delay
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: ['#33F200', '#00203B', '#FFFFFF', '#FFD700'],
                        disableForReducedMotion: true
                    });
                }, 250);

                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: ['#33F200', '#00203B', '#FFFFFF', '#FFD700'],
                        disableForReducedMotion: true
                    });
                }, 400);
            }
        }

        // Show completion celebration - enhanced for mobile
        function showCompletionCelebration() {
            if (typeof confetti === 'function' && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                // Multiple bursts of confetti for a bigger celebration
                const colors = ['#33F200', '#00203B', '#FFFFFF', '#FFD700'];

                // Center burst
                confetti({
                    particleCount: 100,
                    spread: 80,
                    origin: { y: 0.6 },
                    colors: colors,
                    disableForReducedMotion: true
                });

                // Left burst after delay
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0, y: 0.7 },
                        colors: colors,
                        disableForReducedMotion: true
                    });
                }, 200);

                // Right burst after delay
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1, y: 0.7 },
                        colors: colors,
                        disableForReducedMotion: true
                    });
                }, 400);

                // Final top burst
                setTimeout(() => {
                    confetti({
                        particleCount: 75,
                        spread: 100,
                        origin: { y: 0.3 },
                        colors: colors,
                        disableForReducedMotion: true
                    });
                }, 600);
            }

            // Play success sound
            SoundManager.playSuccess();

            // Show toast
            showToast('All predictions submitted! Good luck! üèà');
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toastNotification');
            toast.textContent = message;
            toast.classList.add('show');

            // Hide after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Questions configuration
        const questions = [
            { id: 'winner', label: 'Who wins?', type: 'radio', options: ['Seahawks', 'Patriots'], points: 5 },
            { id: 'totalTDs', label: 'Total touchdowns?', type: 'number', points: 5 },
            { id: 'overtime', label: 'Overtime?', type: 'radio', options: ['Yes', 'No'], points: 5 },
            { id: 'winningMargin', label: 'Winning margin?', type: 'radio', options: ['1-7', '8-14', '15+'], points: 5 },
            { id: 'totalFieldGoals', label: 'Total field goals?', type: 'number', points: 5 },
            { id: 'firstHalfLeader', label: 'Halftime leader?', type: 'radio', options: ['Seahawks', 'Patriots', 'Tied'], points: 5 },
            // { id: 'longestTD', label: 'Longest TD?', type: 'radio', options: ['Under 20', '20-39', '40-50', '50+', '60+'], points: 5 },
            // { id: 'totalTurnovers', label: 'Total turnovers?', type: 'number', points: 5 },
            // { id: 'successfulTwoPoints', label: 'Successful 2-point conversion?', type: 'radio', options: ['Yes', 'No'], points: 5 },
            // { id: 'defensiveTD', label: 'Defensive/special teams TD?', type: 'radio', options: ['Yes', 'No'], points: 5 },
            // { id: 'finalScoreSumEvenOdd', label: 'Final score sum even/odd?', type: 'radio', options: ['Even', 'Odd'], points: 5 },
            // { id: 'seahawksTDs', label: 'Seahawks TDs?', type: 'number', points: 5 },
            // { id: 'patriotsTDs', label: 'Patriots TDs?', type: 'number', points: 5 },
            // { id: 'totalSacks', label: 'Total sacks?', type: 'number', points: 5 },
            { id: 'totalPoints', label: 'TIEBREAKER: Total combined points', type: 'number', points: 0 },
        ];

        // Get or create user ID
        function getUserId() {
            // Check for user ID in URL (for session recovery on different device)
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user');

            if (urlUserId) {
                // Use the URL user ID and save to localStorage
                localStorage.setItem('userId', urlUserId);
                // Clean up URL to remove user parameter (keeps it private)
                urlParams.delete('user');
                const newUrl = urlParams.toString()
                    ? `${window.location.pathname}?${urlParams.toString()}`
                    : window.location.pathname;
                window.history.replaceState({}, '', newUrl);
                return urlUserId;
            }

            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
                localStorage.setItem('userId', userId);
            }
            return userId;
        }

        // Initialize app
        function initApp() {
            console.log('=== INITIALIZING APP ===');

            // Initialize Sound Manager
            SoundManager.init();

            // Initialize InstantDB
            db = window.InstantDBInit({ appId: APP_ID });
            console.log('InstantDB initialized:', db);

            currentUserId = getUserId();
            console.log('Current user ID:', currentUserId);

            // Check for league parameter and admin override
            const urlParams = new URLSearchParams(window.location.search);
            let leagueParam = urlParams.get('league');
            const isAdminOverride = urlParams.get('isAdmin') === 'true';

            // If no URL param, check localStorage for saved league
            if (!leagueParam) {
                const savedLeague = localStorage.getItem('currentLeagueSlug');
                if (savedLeague) {
                    leagueParam = savedLeague;
                    console.log('Restored league from localStorage:', leagueParam);
                    // Update URL to reflect the league (without reload)
                    const newUrl = `${window.location.pathname}?league=${leagueParam}`;
                    window.history.replaceState({}, '', newUrl);
                }
            }

            if (leagueParam) {
                // Save league to localStorage for future visits
                localStorage.setItem('currentLeagueSlug', leagueParam);

                // Subscribe to this specific league by slug
                db.subscribeQuery(
                    {
                        leagues: { $: { where: { slug: leagueParam } } },
                        predictions: {}
                    },
                    (result) => {
                        console.log('=== INSTANTDB SUBSCRIPTION UPDATE ===');
                        console.log('Result:', result);

                        if (result.error) {
                            console.error('InstantDB error:', result.error);
                            return;
                        }

                        currentLeague = result.data.leagues[0];
                        console.log('Current league:', currentLeague);

                        // Detect actualResults changes
                        if (currentLeague) {
                            const currentActualResults = currentLeague.actualResults;

                            // Check if actualResults changed and user is not on scores tab
                            if (previousActualResults !== null &&
                                JSON.stringify(currentActualResults) !== JSON.stringify(previousActualResults) &&
                                currentTab !== 'scores') {

                                // Only show notification if results have content
                                if (currentActualResults && Object.keys(currentActualResults).length > 0) {
                                    hasUnviewedScoreUpdate = true;
                                    updateScoresTabNotification();
                                }
                            }

                            previousActualResults = currentActualResults ? JSON.parse(JSON.stringify(currentActualResults)) : null;
                        }

                        // Filter predictions for this league
                        if (currentLeague) {
                            allPredictions = result.data.predictions.filter(p => p.leagueId === currentLeague.id);
                            isLeagueCreator = currentLeague.creatorId === currentUserId || isAdminOverride;
                            console.log('Is league creator:', isLeagueCreator, '(creatorId:', currentLeague.creatorId, ', userId:', currentUserId, ', adminOverride:', isAdminOverride, ')');
                            console.log('All predictions:', allPredictions);
                        } else {
                            console.log('No league found with slug:', leagueParam);
                            allPredictions = [];
                        }

                        render();
                    }
                );
            } else {
                // No league parameter - show league creation
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('leagueCreation').classList.remove('hidden');
                document.getElementById('leagueForm').onsubmit = handleLeagueCreation;
            }
        }

        // Handle league creation
        async function handleLeagueCreation(e) {
            e.preventDefault();

            const leagueName = document.getElementById('leagueName').value.trim();
            const leagueSlug = leagueName.toLowerCase().replace(/[^a-z0-9]+/g, '-');

            // Check if a league with this slug already exists
            const existingLeague = await db.queryOnce({
                leagues: { $: { where: { slug: leagueSlug } } }
            });

            if (existingLeague.data.leagues && existingLeague.data.leagues.length > 0) {
                alert('A league with this name already exists. Please choose a different name.');
                return;
            }

            // Generate UUID for league
            const leagueId = crypto.randomUUID();

            // Create league
            await db.transact([
                db.tx.leagues[leagueId].update({
                    slug: leagueSlug,
                    name: leagueName,
                    creatorId: currentUserId,
                    isOpen: true,
                    createdAt: Date.now()
                })
            ]);

            // Update URL
            const newUrl = `${window.location.pathname}?league=${leagueSlug}`;
            window.history.pushState({}, '', newUrl);

            // Reload to initialize with league
            window.location.reload();
        }

        // Copy league URL
        function copyLeagueUrl() {
            const url = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        // Render UI
        function render() {
            console.log('=== RENDER CALLED ===');
            document.getElementById('loading').classList.add('hidden');

            if (!currentLeague) {
                console.log('No current league, returning');
                return; // League not found
            }

            console.log('Rendering for league:', currentLeague.name);

            // Store league URL for copy function
            const shareUrl = `${window.location.origin}${window.location.pathname}?league=${currentLeague.slug}`;
            document.getElementById('shareUrl').textContent = shareUrl;

            // Render league name in header
            renderLeagueName();

            // Check if completion celebration was already shown for this league
            if (localStorage.getItem(`completionCelebration-${currentLeague.id}`) === 'true') {
                hasShownCompletionCelebration = true;
            }

            // Check if user has set their team name
            const userPrediction = allPredictions.find(p => p.userId === currentUserId);

            if (!userPrediction) {
                // Show team name entry - don't show leaderboard yet
                document.getElementById('teamNameEntry').classList.remove('hidden');
                document.getElementById('teamNameForm').onsubmit = handleTeamNameSubmit;

                // Hide leaderboard on team entry screen
                const leaderboardSection = document.getElementById('leaderboardSection');
                if (leaderboardSection) {
                    leaderboardSection.classList.add('hidden');
                }
            } else {
                currentTeamName = userPrediction.teamName;
                isManager = userPrediction.isManager === true;

                // Show the intro replay button for returning users
                document.getElementById('introReplayBtn').classList.remove('hidden');

                // Update tab labels with team name
                const adminTab = document.getElementById('adminPredictionsTab');
                const userTab = document.getElementById('userPredictionsTab');
                if (adminTab) adminTab.innerHTML = `Team ${currentTeamName} <button class="team-name-edit-btn" onclick="event.stopPropagation(); openTeamNameModal();">Edit</button>`;
                if (userTab) userTab.innerHTML = `Team ${currentTeamName} <button class="team-name-edit-btn" onclick="event.stopPropagation(); openTeamNameModal();">Edit</button>`;

                // Show admin panel for creator
                if (isLeagueCreator) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    renderAdminControls();
                } else {
                    // Show user panel for non-admin users
                    document.getElementById('userPanel').classList.remove('hidden');
                    renderUserTabs(); // Dynamically render tabs based on manager status
                }

                // Render all content but preserve current tab
                renderPredictionsForm();
                renderParticipants();

                // Restore the correct tab view (preserve current tab on re-renders)
                // The switchTab/switchUserTab functions handle showing leaderboard on Scores tab
                if (isLeagueCreator) {
                    switchTab(currentTab);
                } else {
                    switchUserTab(currentTab);
                }
            }

            // Show all predictions if admin enabled it (defaults to false)
            const showAllPredictions = currentLeague.showAllPredictions === true;
            console.log('Show All Predictions:', showAllPredictions);
            if (showAllPredictions) {
                console.log('Rendering all predictions section...');
                renderAllPredictions();
            } else {
                console.log('Hiding all predictions section...');
                // Hide the section if toggle is off
                document.getElementById('allPredictionsSection').classList.add('hidden');
            }
        }

        // Handle team name submission
        async function handleTeamNameSubmit(e) {
            e.preventDefault();

            const teamName = document.getElementById('teamNameInput').value.trim();

            // Validate length (3-15 characters)
            if (teamName.length < 3 || teamName.length > 15) {
                alert('Team name must be 3-15 characters.');
                return;
            }

            // Check if team name already exists (case-insensitive)
            const teamNameExists = allPredictions.some(p =>
                p.teamName.toLowerCase() === teamName.toLowerCase()
            );

            if (teamNameExists) {
                alert('This team name is already taken. Please choose a different name.');
                return;
            }

            currentTeamName = teamName;

            // Generate UUID for prediction
            const predictionId = crypto.randomUUID();

            // Create initial prediction entry
            await db.transact([
                db.tx.predictions[predictionId].update({
                    leagueId: currentLeague.id,
                    userId: currentUserId,
                    teamName: teamName,
                    submittedAt: Date.now(),
                    score: 0,
                    tiebreakDiff: 0,
                    isManager: false
                })
            ]);

            // Hide team name entry
            document.getElementById('teamNameEntry').classList.add('hidden');

            // Show celebratory intro overlay
            showIntroOverlay(teamName);

            // Show the intro replay button in header
            document.getElementById('introReplayBtn').classList.remove('hidden');
        }

        // ========== TEAM NAME EDITING ==========

        // Open team name edit modal
        function openTeamNameModal() {
            const modal = document.getElementById('teamNameModal');
            const input = document.getElementById('teamNameEditInput');

            // Pre-fill with current team name
            input.value = currentTeamName || '';
            updateTeamNameCharCount();

            // Set up form submit handler
            document.getElementById('teamNameEditForm').onsubmit = handleTeamNameChange;

            modal.showModal();
        }

        // Close team name edit modal
        function closeTeamNameModal() {
            const modal = document.getElementById('teamNameModal');
            modal.close();
        }

        // Update character count display
        function updateTeamNameCharCount() {
            const input = document.getElementById('teamNameEditInput');
            const countDiv = document.getElementById('teamNameCharCount');
            const length = input.value.length;

            countDiv.textContent = `${length}/15 characters (min 3)`;

            // Update styling based on validity
            countDiv.classList.remove('char-count-valid', 'char-count-warning', 'char-count-error');

            if (length < 3) {
                countDiv.classList.add('char-count-error');
            } else if (length > 12) {
                countDiv.classList.add('char-count-warning');
            } else {
                countDiv.classList.add('char-count-valid');
            }
        }

        // Handle team name change submission
        async function handleTeamNameChange(e) {
            e.preventDefault();

            const newName = document.getElementById('teamNameEditInput').value.trim();

            // Validate length
            if (newName.length < 3 || newName.length > 15) {
                showToast('Team name must be 3-15 characters');
                return;
            }

            // Check if same as current name
            if (newName.toLowerCase() === currentTeamName.toLowerCase()) {
                closeTeamNameModal();
                return;
            }

            // Check if team name already exists (case-insensitive, excluding current user)
            const teamNameExists = allPredictions.some(p =>
                p.userId !== currentUserId &&
                p.teamName.toLowerCase() === newName.toLowerCase()
            );

            if (teamNameExists) {
                showToast('This team name is already taken');
                return;
            }

            // Find user's prediction and update
            const userPrediction = allPredictions.find(p => p.userId === currentUserId);
            if (!userPrediction) {
                showToast('Error: Could not find your team');
                return;
            }

            try {
                await db.transact([
                    db.tx.predictions[userPrediction.id].update({
                        teamName: newName
                    })
                ]);

                currentTeamName = newName;
                closeTeamNameModal();
                showToast('Team name updated!');

                // Update tab labels
                const adminTab = document.getElementById('adminPredictionsTab');
                const userTab = document.getElementById('userPredictionsTab');
                if (adminTab) adminTab.innerHTML = `Team ${currentTeamName} <button class="team-name-edit-btn" onclick="event.stopPropagation(); openTeamNameModal();">Edit</button>`;
                if (userTab) userTab.innerHTML = `Team ${currentTeamName} <button class="team-name-edit-btn" onclick="event.stopPropagation(); openTeamNameModal();">Edit</button>`;
            } catch (error) {
                console.error('Error updating team name:', error);
                showToast('Error updating team name');
            }
        }

        // Switch tabs (admin)
        function switchTab(tab) {
            // Handle removed 'participants' tab - redirect to admin
            if (tab === 'participants') tab = 'admin';
            currentTab = tab;
            localStorage.setItem('currentTab', tab);

            // Remove active class from all admin tabs
            document.querySelectorAll('#adminPanel .tab').forEach(btn => {
                btn.classList.remove('tab-active');
            });

            // Hide all sections
            document.getElementById('predictionsSection').classList.add('hidden');
            document.getElementById('leaderboardSection').classList.add('hidden');
            document.getElementById('resultsTab').classList.add('hidden');
            document.getElementById('adminTab').classList.add('hidden');

            if (tab === 'predictions') {
                document.querySelectorAll('#adminPanel .tab')[0].classList.add('tab-active');
                document.getElementById('predictionsSection').classList.remove('hidden');
            } else if (tab === 'scores') {
                document.querySelectorAll('#adminPanel .tab')[1].classList.add('tab-active');
                document.getElementById('leaderboardSection').classList.remove('hidden');
                renderLeaderboard();
                clearScoresNotification();
            } else if (tab === 'results') {
                document.querySelectorAll('#adminPanel .tab')[2].classList.add('tab-active');
                document.getElementById('resultsTab').classList.remove('hidden');
                renderResultsForm();
            } else if (tab === 'admin') {
                document.querySelectorAll('#adminPanel .tab')[3].classList.add('tab-active');
                document.getElementById('adminTab').classList.remove('hidden');
                renderAdminControls();
            }
        }

        // Switch tabs (regular users)
        function switchUserTab(tab) {
            // Non-admins have predictions and scores tabs; managers also have results
            if (tab === 'results' && !isManager) {
                tab = 'predictions'; // Fallback if non-manager tries to access results
            }
            if (tab !== 'predictions' && tab !== 'scores' && tab !== 'results') {
                tab = 'predictions';
            }
            currentTab = tab;
            localStorage.setItem('currentTab', tab);

            // Remove active class from all user tabs
            document.querySelectorAll('#userPanel .tab').forEach(btn => {
                btn.classList.remove('tab-active');
            });

            // Hide all sections
            document.getElementById('predictionsSection').classList.add('hidden');
            document.getElementById('leaderboardSection').classList.add('hidden');
            document.getElementById('resultsTab').classList.add('hidden');

            if (tab === 'predictions') {
                document.querySelectorAll('#userPanel .tab')[0].classList.add('tab-active');
                document.getElementById('predictionsSection').classList.remove('hidden');
            } else if (tab === 'scores') {
                document.querySelectorAll('#userPanel .tab')[1].classList.add('tab-active');
                document.getElementById('leaderboardSection').classList.remove('hidden');
                renderLeaderboard();
                clearScoresNotification();
            } else if (tab === 'results') {
                // Results tab is at index 2 for managers
                document.querySelectorAll('#userPanel .tab')[2].classList.add('tab-active');
                document.getElementById('resultsTab').classList.remove('hidden');
                renderResultsForm();
            }
        }

        // Render user tabs dynamically based on manager status
        function renderUserTabs() {
            const tabsContainer = document.getElementById('userTabs');
            if (!tabsContainer) return;

            let html = `
                <a role="tab" id="userPredictionsTab" class="tab ${currentTab === 'predictions' ? 'tab-active' : ''}" onclick="switchUserTab('predictions')">My Predictions</a>
                <a role="tab" class="tab ${currentTab === 'scores' ? 'tab-active' : ''}" onclick="switchUserTab('scores')">Scores</a>
            `;

            if (isManager) {
                html += `<a role="tab" class="tab tab-results ${currentTab === 'results' ? 'tab-active' : ''}" onclick="switchUserTab('results')">Results</a>`;
            }

            tabsContainer.innerHTML = html;

            // Update My Predictions tab with team name
            const userTab = document.getElementById('userPredictionsTab');
            if (userTab && currentTeamName) {
                userTab.innerHTML = `Team ${currentTeamName} <button class="team-name-edit-btn" onclick="event.stopPropagation(); openTeamNameModal();">Edit</button>`;
            }
        }

        // Render admin controls
        function renderAdminControls() {
            const statusDiv = document.getElementById('gameStatus');
            const showPredictions = currentLeague.showAllPredictions === true; // Default to false
            const shareUrl = `${window.location.origin}${window.location.pathname}?league=${currentLeague.slug}`;

            // Submissions toggle colors
            const submissionsOnStyle = currentLeague.isOpen
                ? 'background: #003320; border: 2px solid #33F200; color: #33F200;'
                : 'background: #1a1520; border: 2px solid #ff6b6b40; color: #9DA2A3;';
            const submissionsOffStyle = !currentLeague.isOpen
                ? 'background: #3d1a1a; border: 2px solid #ff6b6b; color: #ff6b6b;'
                : 'background: #1a1520; border: 2px solid #33F20040; color: #9DA2A3;';

            // Show predictions toggle colors (off = green/safe, on = red/warning)
            const predictionsOffStyle = !showPredictions
                ? 'background: #003320; border: 2px solid #33F200; color: #33F200;'
                : 'background: #1a1520; border: 2px solid #ff6b6b40; color: #9DA2A3;';
            const predictionsOnStyle = showPredictions
                ? 'background: #3d1a1a; border: 2px solid #ff6b6b; color: #ff6b6b;'
                : 'background: #1a1520; border: 2px solid #33F20040; color: #9DA2A3;';

            statusDiv.innerHTML = `
                <div style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #FFFFFF; font-weight: 600; font-size: 15px;">Submissions</span>
                    <div style="display: flex; gap: 6px;">
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; ${currentLeague.isOpen ? 'background: #003320; border: 2px solid #33F200; color: #33F200;' : 'background: #002a4a; border: 2px solid #9DA2A3; color: #9DA2A3;'}">
                            <input type="radio" name="submissions" value="open" ${currentLeague.isOpen ? 'checked' : ''} onchange="setSubmissions(true)" style="width: 16px; height: 16px; accent-color: #33F200;">
                            üîì Open
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; ${!currentLeague.isOpen ? 'background: #3d1a1a; border: 2px solid #ff6b6b; color: #ff6b6b;' : 'background: #002a4a; border: 2px solid #9DA2A3; color: #9DA2A3;'}">
                            <input type="radio" name="submissions" value="closed" ${!currentLeague.isOpen ? 'checked' : ''} onchange="setSubmissions(false)" style="width: 16px; height: 16px; accent-color: #ff6b6b;">
                            üîí Closed
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #FFFFFF; font-weight: 600; font-size: 15px;">Show All Answers</span>
                    <div style="display: flex; gap: 6px;">
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; ${!showPredictions ? 'background: #003320; border: 2px solid #33F200; color: #33F200;' : 'background: #002a4a; border: 2px solid #9DA2A3; color: #9DA2A3;'}">
                            <input type="radio" name="showPredictions" value="hidden" ${!showPredictions ? 'checked' : ''} onchange="setShowPredictions(false)" style="width: 16px; height: 16px; accent-color: #33F200;">
                            üîí Hidden
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; ${showPredictions ? 'background: #3d1a1a; border: 2px solid #ff6b6b; color: #ff6b6b;' : 'background: #002a4a; border: 2px solid #9DA2A3; color: #9DA2A3;'}">
                            <input type="radio" name="showPredictions" value="visible" ${showPredictions ? 'checked' : ''} onchange="setShowPredictions(true)" style="width: 16px; height: 16px; accent-color: #ff6b6b;">
                            üëÅÔ∏è Visible
                        </label>
                    </div>
                </div>

                <div style="padding: 16px; background: #002a4a; border-radius: 8px;">
                    <div style="color: #FFFFFF; font-weight: 600; margin-bottom: 12px;">Invite Others</div>
                    <div style="display: flex; gap: 16px; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="color: #9DA2A3; font-size: 14px; margin-bottom: 8px;">Share link:</div>
                            <a href="#" onclick="copyLeagueUrl(); return false;" style="color: #33F200; font-size: 14px; text-decoration: underline; display: inline-block;">üìã Copy invite link</a>
                            <div style="color: #9DA2A3; font-size: 12px; margin-top: 8px; word-break: break-all;">${shareUrl}</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 8px;">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(shareUrl)}" alt="QR Code" style="display: block; width: 120px; height: 120px;">
                        </div>
                    </div>
                </div>
            `;

            // Preserve collapsed state
            const content = document.getElementById('gameStatusContent');
            const icon = document.getElementById('gameStatusToggleIcon');
            if (gameStatusCollapsed) {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        // Set submissions open/closed
        async function setSubmissions(isOpen) {
            // If already in this state, do nothing
            if (currentLeague.isOpen === isOpen) return;

            // Confirm when closing submissions
            if (!isOpen) {
                const confirmed = confirm('‚ö†Ô∏è Close Submissions?\n\nUsers will no longer be able to submit or edit their predictions.\n\nAre you sure you want to continue?');
                if (!confirmed) {
                    // Revert radio button
                    renderAdminControls();
                    return;
                }
            }

            // Confirm when opening submissions
            if (isOpen) {
                const confirmed = confirm('üîì Open Submissions?\n\nUsers will be able to submit and edit their predictions again.\n\nAre you sure you want to continue?');
                if (!confirmed) {
                    // Revert radio button
                    renderAdminControls();
                    return;
                }
            }

            await db.transact([
                db.tx.leagues[currentLeague.id].update({ isOpen: isOpen })
            ]);
        }

        // Set show all predictions
        async function setShowPredictions(show) {
            const currentValue = currentLeague.showAllPredictions === true; // Default to false

            // If already in this state, do nothing
            if (currentValue === show) return;

            // Confirm when turning ON (showing predictions)
            if (show) {
                const confirmed = confirm('‚ö†Ô∏è Show All Answers?\n\nAll users will be able to see everyone\'s predictions and answers!\n\nThis is typically done after submissions are closed.\n\nAre you sure you want to continue?');
                if (!confirmed) {
                    // Revert radio button
                    renderAdminControls();
                    return;
                }
            }

            // Confirm when turning OFF (hiding predictions)
            if (!show) {
                const confirmed = confirm('üîí Hide All Answers?\n\nUsers will no longer be able to see the predictions table or individual answers.\n\nAre you sure you want to continue?');
                if (!confirmed) {
                    // Revert radio button
                    renderAdminControls();
                    return;
                }
            }

            console.log(`Admin toggling Show All Predictions to: ${show}`);

            await db.transact([
                db.tx.leagues[currentLeague.id].update({ showAllPredictions: show })
            ]);
        }

        // Render results form
        function renderResultsForm() {
            console.log('=== RENDERING RESULTS FORM ===');
            const form = document.getElementById('resultsForm');
            let html = '';

            questions.forEach((q, index) => {
                const hasValue = currentLeague.actualResults?.[q.id] !== undefined &&
                                 currentLeague.actualResults?.[q.id] !== null &&
                                 currentLeague.actualResults?.[q.id] !== '';

                html += `<div class="question-card" style="background: #1a0f0f; border: 1px solid #e5737340; border-left: 4px solid #e57373;">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                    <label style="margin: 0;">
                        <span style="color: #ef9a9a; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">Question ${index + 1}</span><br>
                        <span style="color: #FFFFFF;">${q.label}</span>
                        <span style="display: inline-block; background: #e57373; color: #FFFFFF; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 700; margin-left: 10px;">${q.points} pts</span>
                    </label>
                    ${hasValue ? `<button type="button" onclick="clearResult('${q.id}')" style="background: rgba(229, 115, 115, 0.2); color: #e57373; border: 1px solid #e57373; padding: 8px 14px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">‚úï Clear</button>` : ''}
                </div>`;

                if (q.type === 'radio') {
                    q.options.forEach(option => {
                        const value = option.toLowerCase().replace(/\s+/g, '-');
                        const checked = currentLeague.actualResults?.[q.id] === value ? 'checked' : '';
                        const selectedStyle = checked ? 'background-color: #2d1515; border-color: #e57373; box-shadow: 0 0 0 3px rgba(229, 115, 115, 0.3);' : 'background-color: #1a0f0f; border-color: #e5737360;';
                        html += `
                            <label class="radio-option" style="${selectedStyle}">
                                <input type="radio" name="result-${q.id}" value="${value}" ${checked} style="accent-color: #e57373;">
                                <span>${option}</span>
                            </label>
                        `;
                    });
                } else {
                    const value = currentLeague.actualResults?.[q.id] ?? '';
                    html += `<input type="number" name="result-${q.id}" value="${value}" min="0" placeholder="Enter number" style="background: #1a0f0f; border-color: #e5737360;">`;
                }

                html += `</div>`;
            });

            html += `<div style="background: rgba(96, 165, 250, 0.15); border: 1px solid #60a5fa; border-radius: 12px; padding: 16px; margin-top: 24px; display: flex; align-items: center; gap: 12px;"><span style="font-size: 20px;">‚ÑπÔ∏è</span><span style="color: #FFFFFF; font-size: 16px;">Results are saved automatically as you enter them.</span></div>`;

            form.innerHTML = html;

            // Add auto-save event listeners
            const inputs = form.querySelectorAll('input[type="radio"], input[type="number"]');
            console.log('Adding auto-save listeners to', inputs.length, 'inputs');
            inputs.forEach(input => {
                input.addEventListener('change', handleResultsAutoSave);
            });
            console.log('Auto-save listeners attached');
        }

        // Handle results submission
        async function handleResultsSubmit(e) {
            e.preventDefault();

            try {
                const formData = new FormData(e.target);
                const actualResults = {};

                questions.forEach(q => {
                    const value = formData.get(`result-${q.id}`);
                    if (q.type === 'number') {
                        actualResults[q.id] = parseInt(value) || 0;
                    } else {
                        actualResults[q.id] = value;
                    }
                });

                console.log('Actual results:', actualResults);

                // Calculate scores for all predictions
                const updates = [];

                allPredictions.forEach(pred => {
                    if (pred.predictions) {
                        const score = calculateScore(pred.predictions, actualResults);
                        const tiebreakDiff = Math.abs((pred.predictions?.totalPoints || 0) - (actualResults.totalPoints || 0));

                        console.log(`${pred.teamName}: score=${score}, tiebreak=${tiebreakDiff}`);

                        updates.push(
                            db.tx.predictions[pred.id].update({
                                score,
                                tiebreakDiff
                            })
                        );
                    }
                });

                // Update league with actual results
                updates.push(
                    db.tx.leagues[currentLeague.id].update({ actualResults })
                );

                console.log('Saving updates...', updates.length);
                await db.transact(updates);
                console.log('Updates saved successfully');

                // Update leaderboard immediately
                renderLeaderboard();

                alert('Results saved and scores calculated! Check the Scores tab to see the leaderboard.');
            } catch (error) {
                console.error('Error saving results:', error);
                alert('Error saving results: ' + error.message);
            }
        }

        // Calculate score
        function calculateScore(predictions, actualResults) {
            if (!predictions || !actualResults) return 0;

            let score = 0;
            const debug = [];

            questions.forEach(q => {
                if (q.id === 'totalPoints') return; // Tiebreaker, no points

                const predicted = predictions[q.id];
                const actual = actualResults[q.id];

                // Only award points if BOTH prediction and actual result exist
                if (predicted === undefined || predicted === null || predicted === '' ||
                    actual === undefined || actual === null || actual === '') {
                    debug.push(`‚äò ${q.id}: no answer set (predicted="${predicted}", actual="${actual}")`);
                    return;
                }

                let isCorrect = false;
                if (q.type === 'number') {
                    isCorrect = parseInt(predicted) === parseInt(actual);
                } else {
                    // Both should be in slug format (lowercase with dashes)
                    isCorrect = predicted === actual;
                }

                if (isCorrect) {
                    score += q.points;
                    debug.push(`‚úì ${q.id}: "${predicted}" === "${actual}" (+${q.points})`);
                } else {
                    debug.push(`‚úó ${q.id}: "${predicted}" !== "${actual}"`);
                }
            });

            console.log('Score calculation:', debug.join('\n'));
            return score;
        }

        // Render predictions form
        function renderPredictionsForm() {
            document.getElementById('predictionsSection').classList.remove('hidden');

            // Show status only when closed
            const statusDiv = document.getElementById('submissionsStatus');
            if (currentLeague.isOpen) {
                statusDiv.innerHTML = '';
            } else {
                statusDiv.innerHTML = `
                    <div class="closed-banner">
                        üîí Submissions Closed - Your predictions are locked in!
                    </div>
                `;
            }

            // Add/remove readonly class on predictions section
            const predictionsSection = document.getElementById('predictionsSection');
            if (!currentLeague.isOpen) {
                predictionsSection.classList.add('submissions-closed');
            } else {
                predictionsSection.classList.remove('submissions-closed');
            }

            const form = document.getElementById('predictionsForm');
            let html = '';

            // Get existing predictions
            const userPrediction = allPredictions.find(p => p.userId === currentUserId);

            // Check if results exist for showing correct answers
            const hasResults = currentLeague.actualResults && Object.keys(currentLeague.actualResults).length > 0;
            const showCorrectAnswers = !currentLeague.isOpen && hasResults;

            questions.forEach((q, index) => {
                const userAnswer = userPrediction?.predictions?.[q.id];
                const correctAnswer = currentLeague.actualResults?.[q.id];
                const hasCorrectAnswer = correctAnswer !== undefined && correctAnswer !== null && correctAnswer !== '';

                // Determine if user's answer is correct
                let isCorrect = false;
                if (hasCorrectAnswer && userAnswer !== undefined && userAnswer !== null && userAnswer !== '') {
                    if (q.type === 'number') {
                        isCorrect = parseInt(userAnswer) === parseInt(correctAnswer);
                    } else {
                        isCorrect = userAnswer === correctAnswer;
                    }
                }

                html += `<div class="question-card">`;
                html += `<label>
                    <span style="color: #33F200; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">Question ${index + 1}</span><br>
                    <span style="color: #FFFFFF;">${q.label}</span>
                    ${q.points > 0 ? `<span style="display: inline-block; background: #33F200; color: #00203B; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 700; margin-left: 10px;">${q.points} pts</span>` : '<span style="display: inline-block; background: #9DA2A3; color: #00203B; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; margin-left: 10px;">Tiebreaker</span>'}
                </label>`;

                if (q.type === 'radio') {
                    q.options.forEach(option => {
                        const value = option.toLowerCase().replace(/\s+/g, '-');
                        const checked = userAnswer === value ? 'checked' : '';
                        // Apply correct/incorrect styling when showing results
                        let answerClass = '';
                        if (showCorrectAnswers && hasCorrectAnswer && checked) {
                            answerClass = isCorrect ? 'user-answer-correct' : 'user-answer-incorrect';
                        }
                        html += `
                            <label class="radio-option ${answerClass}">
                                <input type="radio" name="${q.id}" value="${value}" ${checked} ${!currentLeague.isOpen ? 'disabled' : ''}>
                                <span>${option}</span>
                            </label>
                        `;
                    });
                } else {
                    const value = userAnswer || '';
                    // Apply correct/incorrect styling for number inputs
                    let inputClass = '';
                    if (showCorrectAnswers && hasCorrectAnswer && value !== '') {
                        inputClass = isCorrect ? 'user-answer-correct' : 'user-answer-incorrect';
                    }
                    html += `<input type="number" name="${q.id}" value="${value}" min="0" ${!currentLeague.isOpen ? 'disabled' : ''} placeholder="Enter number" class="${inputClass}">`;
                }

                // Show correct answer indicator when submissions are closed and results exist
                if (showCorrectAnswers && hasCorrectAnswer) {
                    // Format the correct answer for display
                    let displayCorrectAnswer = correctAnswer;
                    if (q.type === 'radio') {
                        displayCorrectAnswer = String(correctAnswer).split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    }

                    const indicatorClass = isCorrect ? 'correct' : 'incorrect';
                    const indicatorIcon = isCorrect ? '‚úì' : '‚úó';
                    const indicatorText = isCorrect ? 'Correct!' : `Correct answer: ${displayCorrectAnswer}`;

                    html += `
                        <div class="correct-answer-indicator ${indicatorClass}">
                            <span class="indicator-icon">${indicatorIcon}</span>
                            <span>${indicatorText}</span>
                        </div>
                    `;
                }

                html += `</div>`;
            });

            if (currentLeague.isOpen) {
                html += `<div class="alert alert-info mt-6"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Your answers are saved automatically as you select them.</span></div>`;
            }

            form.innerHTML = html;

            // Add auto-save event listeners
            if (currentLeague.isOpen) {
                form.querySelectorAll('input[type="radio"], input[type="number"]').forEach(input => {
                    input.addEventListener('change', handleAutoSave);
                });
            }

            // Initialize progress bar with current state
            updateProgressBar();
        }

        // Handle auto-save
        let autoSaveTimeout = null;
        async function handleAutoSave() {
            // Always update progress bar on change
            updateProgressBar();

            if (!currentLeague.isOpen) return;

            // Show saving status
            const statusDiv = document.getElementById('autoSaveStatus');
            statusDiv.textContent = 'Saving...';
            statusDiv.style.color = 'var(--seahawks-grey)';

            // Debounce to avoid too many saves
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                const form = document.getElementById('predictionsForm');
                const formData = new FormData(form);
                const predictions = {};

                questions.forEach(q => {
                    const value = formData.get(q.id);
                    if (value !== null && value !== '') {
                        if (q.type === 'number') {
                            predictions[q.id] = parseInt(value) || 0;
                        } else {
                            predictions[q.id] = value;
                        }
                    }
                });

                // Find user's prediction
                const userPrediction = allPredictions.find(p => p.userId === currentUserId);

                if (userPrediction) {
                    try {
                        await db.transact([
                            db.tx.predictions[userPrediction.id].update({
                                predictions,
                                submittedAt: Date.now()
                            })
                        ]);

                        // Show saved status
                        statusDiv.textContent = '‚úì Saved';
                        statusDiv.style.color = 'var(--seahawks-green)';

                        // Update participants list in background (don't wait for re-render from subscription)
                        // This ensures immediate visual feedback
                        renderParticipants();

                        // Check if all predictions are complete - trigger celebration once
                        const answeredCount = Object.keys(predictions).length;
                        if (answeredCount === questions.length && !hasShownCompletionCelebration) {
                            hasShownCompletionCelebration = true;
                            // Store in localStorage to persist across page reloads
                            localStorage.setItem(`completionCelebration-${currentLeague.id}`, 'true');
                            showCompletionCelebration();
                        }

                        // Hide status after 2 seconds
                        setTimeout(() => {
                            statusDiv.textContent = '';
                        }, 2000);
                    } catch (error) {
                        statusDiv.textContent = '‚úó Error saving';
                        statusDiv.style.color = '#dc2626';
                        console.error('Auto-save error:', error);
                    }
                }
            }, 500); // Wait 500ms after last change
        }

        // Handle predictions submission (legacy, kept for compatibility)
        async function handlePredictionsSubmit(e) {
            e.preventDefault();
            // Auto-save handles this now
        }

        // Clear a specific result
        async function clearResult(questionId) {
            console.log('=== CLEARING RESULT FOR:', questionId, '===');

            try {
                // Get current actual results
                const actualResults = { ...currentLeague.actualResults };

                // Remove this question's result
                delete actualResults[questionId];

                console.log('Updated results after clear:', actualResults);

                // Calculate scores for all predictions with updated results
                const updates = [];

                allPredictions.forEach(pred => {
                    if (pred.predictions) {
                        const score = calculateScore(pred.predictions, actualResults);
                        const tiebreakDiff = Math.abs((pred.predictions?.totalPoints || 0) - (actualResults.totalPoints || 0));

                        updates.push(
                            db.tx.predictions[pred.id].update({
                                score,
                                tiebreakDiff
                            })
                        );
                    }
                });

                // Update league with new actual results
                updates.push(
                    db.tx.leagues[currentLeague.id].update({ actualResults })
                );

                await db.transact(updates);

                console.log('Result cleared and scores updated');

                // Show feedback
                const statusDiv = document.getElementById('resultsAutoSaveStatus');
                statusDiv.textContent = '‚úì Result cleared and scores updated';
                statusDiv.style.color = 'var(--seahawks-green)';

                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 2000);

                // Re-render the form to uncheck the radio buttons
                renderResultsForm();
                renderLeaderboard();
            } catch (error) {
                console.error('Error clearing result:', error);
                alert('Error clearing result: ' + error.message);
            }
        }

        // Handle auto-save for results
        let resultsAutoSaveTimeout = null;
        async function handleResultsAutoSave() {
            console.log('=== RESULTS AUTO-SAVE TRIGGERED ===');

            // Show saving status
            const statusDiv = document.getElementById('resultsAutoSaveStatus');
            statusDiv.textContent = 'Saving...';
            statusDiv.style.color = 'var(--seahawks-grey)';

            // Debounce to avoid too many saves
            clearTimeout(resultsAutoSaveTimeout);
            resultsAutoSaveTimeout = setTimeout(async () => {
                try {
                    const form = document.getElementById('resultsForm');
                    const formData = new FormData(form);
                    const actualResults = {};

                    questions.forEach(q => {
                        const value = formData.get(`result-${q.id}`);
                        if (value !== null && value !== '') {
                            if (q.type === 'number') {
                                actualResults[q.id] = parseInt(value) || 0;
                            } else {
                                actualResults[q.id] = value;
                            }
                        }
                    });

                    console.log('Auto-saving results:', actualResults);
                    console.log('Actual results keys:', Object.keys(actualResults));
                    console.log('Actual results values:', Object.values(actualResults));

                    // Calculate scores for all predictions
                    const updates = [];

                    allPredictions.forEach(pred => {
                        if (pred.predictions) {
                            console.log(`\n=== Calculating score for ${pred.teamName} ===`);
                            console.log('Their predictions:', pred.predictions);
                            const score = calculateScore(pred.predictions, actualResults);
                            const tiebreakDiff = Math.abs((pred.predictions?.totalPoints || 0) - (actualResults.totalPoints || 0));

                            console.log(`${pred.teamName}: FINAL SCORE=${score}, tiebreak=${tiebreakDiff}`);

                            updates.push(
                                db.tx.predictions[pred.id].update({
                                    score,
                                    tiebreakDiff
                                })
                            );
                        }
                    });

                    // Update league with actual results
                    updates.push(
                        db.tx.leagues[currentLeague.id].update({ actualResults })
                    );

                    await db.transact(updates);

                    // Show saved status
                    statusDiv.textContent = '‚úì Saved & scores updated';
                    statusDiv.style.color = 'var(--seahawks-green)';

                    // Update leaderboard immediately
                    renderLeaderboard();

                    // Hide status after 2 seconds
                    setTimeout(() => {
                        statusDiv.textContent = '';
                    }, 2000);
                } catch (error) {
                    statusDiv.textContent = '‚úó Error saving';
                    statusDiv.style.color = '#dc2626';
                    console.error('Auto-save error:', error);
                }
            }, 500); // Wait 500ms after last change
        }

        // Update Scores tab visual notification
        function updateScoresTabNotification() {
            const adminScoresTab = document.querySelector('#adminPanel .tab[onclick*="scores"]');
            const userScoresTab = document.querySelector('#userPanel .tab[onclick*="scores"]');

            if (hasUnviewedScoreUpdate) {
                if (adminScoresTab) adminScoresTab.classList.add('tab-scores-notify');
                if (userScoresTab) userScoresTab.classList.add('tab-scores-notify');
            } else {
                if (adminScoresTab) adminScoresTab.classList.remove('tab-scores-notify');
                if (userScoresTab) userScoresTab.classList.remove('tab-scores-notify');
            }
        }

        // Clear notification when viewing scores
        function clearScoresNotification() {
            hasUnviewedScoreUpdate = false;
            updateScoresTabNotification();
        }

        // Render leaderboard
        function renderLeaderboard() {
            const leaderboardDiv = document.getElementById('leaderboard');

            const teamsWithPredictions = allPredictions.filter(p => p.predictions);

            if (teamsWithPredictions.length === 0) {
                leaderboardDiv.innerHTML = '<div class="alert"><span>No predictions yet!</span></div>';
                return;
            }

            document.getElementById('leaderboardSection').classList.remove('hidden');

            // Check if any scores have been calculated
            const hasScores = currentLeague.actualResults && Object.keys(currentLeague.actualResults).length > 0;

            // Sort by score (desc), then tiebreak diff (asc), then team name (alphabetic)
            const sorted = [...teamsWithPredictions].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (a.tiebreakDiff !== b.tiebreakDiff) return a.tiebreakDiff - b.tiebreakDiff;
                return a.teamName.localeCompare(b.teamName);
            });

            let html = '';

            // Count how many questions admin has answered
            const answeredCount = countAnsweredQuestions(currentLeague.actualResults);
            const totalQuestions = questions.length;

            // Show status message about admin progress
            if (answeredCount < totalQuestions) {
                html += `<div class="alert alert-info mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>${answeredCount} out of ${totalQuestions} answers checked.</span>
                </div>`;
            }

            // Track if we should trigger winner celebration
            let shouldCelebrate = false;

            sorted.forEach((pred, index) => {
                const isFirst = index === 0 && pred.score > 0 && hasScores;
                const isSecond = index === 1 && pred.score > 0 && hasScores;
                const isThird = index === 2 && pred.score > 0 && hasScores;
                const uniqueId = `answers-${pred.id}`;
                const canShowAnswers = !currentLeague.isOpen && currentLeague.showAllPredictions === true;

                // Determine place styling
                let placeClass = '';
                let placeEmoji = '';
                let shimmerClass = '';

                if (isFirst) {
                    placeClass = 'place-gold';
                    placeEmoji = '<span class="trophy-bounce" style="font-size: 28px; margin-right: 8px;">üèÜ</span>';
                    shimmerClass = 'winner-shimmer';
                    shouldCelebrate = true;
                } else if (isSecond) {
                    placeClass = 'place-silver';
                    placeEmoji = '<span style="font-size: 24px; margin-right: 8px;">ü•à</span>';
                } else if (isThird) {
                    placeClass = 'place-bronze';
                    placeEmoji = '<span style="font-size: 24px; margin-right: 8px;">ü•â</span>';
                }

                html += `
                    <div class="card bg-base-200 shadow-lg ${placeClass} ${shimmerClass}">
                        <div class="card-body p-4">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        ${placeEmoji}
                                        <span class="badge badge-lg ${isFirst ? 'badge-primary' : 'badge-ghost'}">${index + 1}</span>
                                        <h3 class="text-lg font-bold">${pred.teamName}</h3>
                                    </div>
                                    ${pred.tiebreakDiff > 0 && hasScores ? `<div class="text-xs text-base-content/60 mt-1">Tiebreaker diff: ${pred.tiebreakDiff}</div>` : ''}
                                </div>
                                <div class="text-3xl font-bold text-primary">${hasScores ? pred.score : 0}</div>
                            </div>
                            ${canShowAnswers ? `
                                <button class="btn btn-ghost btn-sm mt-2" onclick="toggleAnswers('${uniqueId}')">
                                    <span class="toggle-text">Show answers ‚ñº</span>
                                </button>
                                <div id="${uniqueId}" class="collapsible-answers">
                                    ${renderAnswerDetails(pred, currentLeague.actualResults)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            leaderboardDiv.innerHTML = html;

            // Trigger winner celebration if there's a first place winner
            if (shouldCelebrate && answeredCount === totalQuestions) {
                // Small delay to let the DOM update
                setTimeout(() => {
                    triggerWinnerCelebration();
                }, 300);
            }
        }

        // Toggle answers visibility
        function toggleAnswers(id) {
            const element = document.getElementById(id);
            const toggleBtn = element.previousElementSibling;
            const toggleText = toggleBtn.querySelector('.toggle-text');

            if (element.classList.contains('active')) {
                element.classList.remove('active');
                if (toggleText) toggleText.textContent = 'Show answers ‚ñº';
            } else {
                element.classList.add('active');
                if (toggleText) toggleText.textContent = 'Hide answers ‚ñ≤';
            }
        }

        // Toggle Game Status visibility
        let gameStatusCollapsed = false;
        function toggleGameStatus() {
            const content = document.getElementById('gameStatusContent');
            const icon = document.getElementById('gameStatusToggleIcon');
            gameStatusCollapsed = !gameStatusCollapsed;

            if (gameStatusCollapsed) {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            } else {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            }
        }

        // Toggle Participants visibility
        let participantsCollapsed = true; // Start collapsed
        function toggleParticipants() {
            const content = document.getElementById('participantsContent');
            const icon = document.getElementById('participantsToggleIcon');
            participantsCollapsed = !participantsCollapsed;

            if (participantsCollapsed) {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            } else {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
                renderParticipants(); // Refresh when opening
            }
        }

        // Toggle Test Scoring visibility
        let testScoringCollapsed = true; // Start collapsed
        function toggleTestScoring() {
            const content = document.getElementById('testScoringContent');
            const icon = document.getElementById('testScoringToggleIcon');
            testScoringCollapsed = !testScoringCollapsed;

            if (testScoringCollapsed) {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            } else {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            }
        }

        // Toggle Recalculate Scores visibility
        let recalculateScoresCollapsed = true; // Start collapsed
        function toggleRecalculateScores() {
            const content = document.getElementById('recalculateScoresContent');
            const icon = document.getElementById('recalculateScoresToggleIcon');
            recalculateScoresCollapsed = !recalculateScoresCollapsed;

            if (recalculateScoresCollapsed) {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            } else {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            }
        }

        // Recalculate scores for all participants
        async function recalculateAllScores() {
            const statusDiv = document.getElementById('recalculateScoresStatus');
            const btn = document.getElementById('recalculateScoresBtn');

            // Check if results exist
            if (!currentLeague.actualResults || Object.keys(currentLeague.actualResults).length === 0) {
                statusDiv.innerHTML = '<div class="alert alert-warning"><span>‚ö†Ô∏è No results entered yet. Please enter actual results first.</span></div>';
                return;
            }

            try {
                // Disable button and show processing status
                btn.disabled = true;
                btn.textContent = '‚è≥ Recalculating...';
                statusDiv.innerHTML = '<div style="color: #9DA2A3; text-align: center; padding: 10px;">Recalculating scores for all participants...</div>';

                const updates = [];
                const actualResults = currentLeague.actualResults;

                // Recalculate scores for all predictions
                allPredictions.forEach(pred => {
                    if (pred.predictions) {
                        const score = calculateScore(pred.predictions, actualResults);
                        const tiebreakDiff = Math.abs((pred.predictions?.totalPoints || 0) - (actualResults.totalPoints || 0));

                        updates.push(
                            db.tx.predictions[pred.id].update({
                                score,
                                tiebreakDiff
                            })
                        );
                    }
                });

                // Execute all updates
                await db.transact(updates);

                // Show success status
                statusDiv.innerHTML = `<div class="alert alert-success"><span>‚úì Successfully recalculated scores for ${updates.length} participant(s)</span></div>`;

                // Update leaderboard immediately
                renderLeaderboard();

                // Re-enable button
                btn.disabled = false;
                btn.textContent = 'üîÑ Recalculate All Scores';

                // Hide status after 3 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-error"><span>‚úó Error recalculating scores</span></div>';
                console.error('Recalculate error:', error);

                // Re-enable button
                btn.disabled = false;
                btn.textContent = 'üîÑ Recalculate All Scores';
            }
        }

        // Run scoring tests
        function runScoringTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div style="color: #9DA2A3; text-align: center; padding: 20px;">Running tests...</div>';

            // Define test cases
            const testCases = [
                {
                    name: 'Perfect Score Test',
                    description: 'All predictions match actual results',
                    predictions: {
                        winner: 'seahawks',
                        totalTDs: 7,
                        overtime: 'no',
                        winningMargin: '8-14',
                        totalFieldGoals: 3,
                        firstHalfLeader: 'seahawks',
                        longestTD: '40-50',
                        totalTurnovers: 4,
                        successfulTwoPoints: 'no',
                        defensiveTD: 'yes',
                        finalScoreSumEvenOdd: 'even',
                        seahawksTDs: 4,
                        patriotsTDs: 3,
                        totalSacks: 5,
                        totalPoints: 56
                    },
                    actualResults: {
                        winner: 'seahawks',
                        totalTDs: 7,
                        overtime: 'no',
                        winningMargin: '8-14',
                        totalFieldGoals: 3,
                        firstHalfLeader: 'seahawks',
                        longestTD: '40-50',
                        totalTurnovers: 4,
                        successfulTwoPoints: 'no',
                        defensiveTD: 'yes',
                        finalScoreSumEvenOdd: 'even',
                        seahawksTDs: 4,
                        patriotsTDs: 3,
                        totalSacks: 5,
                        totalPoints: 60
                    },
                    expectedScore: 70 // All 14 questions correct (5 points each), tiebreaker doesn't count
                },
                {
                    name: 'Zero Score Test',
                    description: 'No predictions match actual results',
                    predictions: {
                        winner: 'patriots',
                        totalTDs: 5,
                        overtime: 'yes',
                        winningMargin: '1-7',
                        totalFieldGoals: 2,
                        firstHalfLeader: 'patriots',
                        longestTD: 'under-20',
                        totalTurnovers: 2,
                        successfulTwoPoints: 'yes',
                        defensiveTD: 'no',
                        finalScoreSumEvenOdd: 'odd',
                        seahawksTDs: 2,
                        patriotsTDs: 5,
                        totalSacks: 3,
                        totalPoints: 42
                    },
                    actualResults: {
                        winner: 'seahawks',
                        totalTDs: 7,
                        overtime: 'no',
                        winningMargin: '8-14',
                        totalFieldGoals: 3,
                        firstHalfLeader: 'seahawks',
                        longestTD: '40-50',
                        totalTurnovers: 4,
                        successfulTwoPoints: 'no',
                        defensiveTD: 'yes',
                        finalScoreSumEvenOdd: 'even',
                        seahawksTDs: 4,
                        patriotsTDs: 3,
                        totalSacks: 5,
                        totalPoints: 60
                    },
                    expectedScore: 0
                },
                {
                    name: 'Partial Score Test',
                    description: 'Some predictions match (6 out of 14)',
                    predictions: {
                        winner: 'seahawks',        // ‚úì correct
                        totalTDs: 7,              // ‚úì correct
                        overtime: 'yes',          // ‚úó wrong
                        winningMargin: '8-14',    // ‚úì correct
                        totalFieldGoals: 2,       // ‚úó wrong
                        firstHalfLeader: 'patriots', // ‚úó wrong
                        longestTD: '40-50',       // ‚úì correct
                        totalTurnovers: 2,        // ‚úó wrong
                        successfulTwoPoints: 'no', // ‚úì correct
                        defensiveTD: 'no',        // ‚úó wrong
                        finalScoreSumEvenOdd: 'odd', // ‚úó wrong
                        seahawksTDs: 2,           // ‚úó wrong
                        patriotsTDs: 3,           // ‚úì correct
                        totalSacks: 3,            // ‚úó wrong
                        totalPoints: 42
                    },
                    actualResults: {
                        winner: 'seahawks',
                        totalTDs: 7,
                        overtime: 'no',
                        winningMargin: '8-14',
                        totalFieldGoals: 3,
                        firstHalfLeader: 'seahawks',
                        longestTD: '40-50',
                        totalTurnovers: 4,
                        successfulTwoPoints: 'no',
                        defensiveTD: 'yes',
                        finalScoreSumEvenOdd: 'even',
                        seahawksTDs: 4,
                        patriotsTDs: 3,
                        totalSacks: 5,
                        totalPoints: 60
                    },
                    expectedScore: 30 // 6 questions correct √ó 5 points each
                },
                {
                    name: 'Incomplete Results Test',
                    description: 'Not all actual results entered yet',
                    predictions: {
                        winner: 'seahawks',
                        totalTDs: 7,
                        overtime: 'no',
                        winningMargin: '8-14',
                        totalFieldGoals: 3,
                        firstHalfLeader: 'seahawks',
                        longestTD: '40-50',
                        totalTurnovers: 4,
                        successfulTwoPoints: 'no',
                        defensiveTD: 'yes',
                        finalScoreSumEvenOdd: 'even',
                        seahawksTDs: 4,
                        patriotsTDs: 3,
                        totalSacks: 5,
                        totalPoints: 56
                    },
                    actualResults: {
                        winner: 'seahawks',       // Only 3 questions answered
                        totalTDs: 7,
                        overtime: 'no'
                    },
                    expectedScore: 15 // Only 3 questions can be scored
                }
            ];

            // Run tests
            let html = '<div style="margin-top: 16px;">';
            let passedCount = 0;
            let failedCount = 0;

            testCases.forEach((test, index) => {
                const actualScore = calculateScore(test.predictions, test.actualResults);
                const passed = actualScore === test.expectedScore;

                if (passed) passedCount++;
                else failedCount++;

                const bgColor = passed ? '#003320' : '#3d1a1a';
                const borderColor = passed ? '#33F200' : '#ff6b6b';
                const textColor = passed ? '#33F200' : '#ff6b6b';
                const icon = passed ? '‚úì' : '‚úó';

                html += `
                    <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-left: 6px solid ${borderColor}; border-radius: 10px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: ${textColor}; font-size: 16px;">${icon} Test ${index + 1}: ${test.name}</strong>
                            <span style="color: ${textColor}; font-size: 18px; font-weight: 700;">${passed ? 'PASS' : 'FAIL'}</span>
                        </div>
                        <div style="color: #9DA2A3; font-size: 14px; margin-bottom: 8px;">${test.description}</div>
                        <div style="color: #FFFFFF; font-size: 14px;">
                            Expected: <strong style="color: ${textColor};">${test.expectedScore}</strong> points
                            | Actual: <strong style="color: ${textColor};">${actualScore}</strong> points
                        </div>
                    </div>
                `;
            });

            // Summary
            const allPassed = failedCount === 0;
            const summaryBg = allPassed ? '#003320' : '#3d1a1a';
            const summaryBorder = allPassed ? '#33F200' : '#ff6b6b';
            const summaryColor = allPassed ? '#33F200' : '#ff6b6b';

            html += `
                <div style="background: ${summaryBg}; border: 3px solid ${summaryBorder}; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 8px;">${allPassed ? 'üéâ' : '‚ö†Ô∏è'}</div>
                    <div style="color: ${summaryColor}; font-size: 20px; font-weight: 700; margin-bottom: 8px;">
                        ${allPassed ? 'All Tests Passed!' : 'Some Tests Failed'}
                    </div>
                    <div style="color: #FFFFFF; font-size: 16px;">
                        ${passedCount} passed, ${failedCount} failed
                    </div>
                </div>
            `;

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // Render answer details for a prediction
        function renderAnswerDetails(pred, actualResults) {
            if (!pred.predictions) {
                return '<div style="padding: 12px; color: #9DA2A3; text-align: center;">No predictions submitted</div>';
            }

            let html = '';
            questions.forEach(q => {
                const userAnswer = pred.predictions[q.id];
                const correctAnswer = actualResults?.[q.id];

                // Format the answer for display
                let displayAnswer = userAnswer;
                if (q.type === 'radio' && userAnswer) {
                    // Convert from slug format back to readable format
                    displayAnswer = userAnswer.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                }

                // Determine if answer is correct and set colors
                let bgColor = '#00203B';
                let borderColor = '#9DA2A3';
                let textColor = '#FFFFFF';
                let statusIcon = '';
                let answerClass = '';

                if (correctAnswer !== undefined && correctAnswer !== null && correctAnswer !== '') {
                    if (userAnswer === correctAnswer || (q.type === 'number' && parseInt(userAnswer) === parseInt(correctAnswer))) {
                        answerClass = 'correct';
                        bgColor = '#003320';
                        borderColor = '#33F200';
                        textColor = '#33F200';
                        statusIcon = '‚úì';
                    } else {
                        answerClass = 'incorrect';
                        bgColor = '#330a0a';
                        borderColor = '#ff6b6b';
                        textColor = '#ff9999';
                        statusIcon = '‚úó';
                    }
                }

                html += `
                    <div class="answer-item ${answerClass}" style="background-color: ${bgColor}; border: 2px solid ${borderColor}; ${answerClass ? `border-left: 6px solid ${borderColor};` : ''} padding: 16px 20px; margin: 8px 0; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: ${textColor}; font-size: 16px; font-weight: 500;">${q.label}</span>
                        <span style="color: ${textColor}; font-size: 18px; font-weight: 700;">
                            ${displayAnswer || '-'}
                            ${statusIcon ? `<strong style="margin-left: 10px; font-size: 20px;">${statusIcon}</strong>` : ''}
                        </span>
                    </div>
                `;
            });

            return html;
        }

        // Render participants
        function renderParticipants() {
            const participantsDiv = document.getElementById('participantsList');

            if (allPredictions.length === 0) {
                participantsDiv.innerHTML = '<div class="alert"><span>No participants yet!</span></div>';
                return;
            }

            // Sort by number of answered questions (descending), then by team name
            const sorted = [...allPredictions].sort((a, b) => {
                const aAnswered = countAnsweredQuestions(a.predictions);
                const bAnswered = countAnsweredQuestions(b.predictions);

                if (bAnswered !== aAnswered) return bAnswered - aAnswered;
                return a.teamName.localeCompare(b.teamName);
            });

            let html = '';
            sorted.forEach((pred) => {
                const answeredCount = countAnsweredQuestions(pred.predictions);
                const totalQuestions = questions.length;
                const percentage = Math.round((answeredCount / totalQuestions) * 100);
                const isComplete = answeredCount === totalQuestions;
                const participantIsManager = pred.isManager === true;

                // Manager toggle (only visible to admin)
                const managerToggle = isLeagueCreator ? `
                    <div class="mt-3" style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #9DA2A3; font-size: 13px; font-weight: 500;">Manager?</span>
                        <label style="display: flex; gap: 4px;">
                            <button onclick="toggleManager('${pred.id}', false)" style="padding: 6px 12px; border-radius: 6px 0 0 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; ${!participantIsManager ? 'background: #33F200; color: #00203B; border: 2px solid #33F200;' : 'background: #002a4a; color: #9DA2A3; border: 2px solid #9DA2A3;'}">No</button>
                            <button onclick="toggleManager('${pred.id}', true)" style="padding: 6px 12px; border-radius: 0 6px 6px 0; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; ${participantIsManager ? 'background: #f59e0b; color: #00203B; border: 2px solid #f59e0b;' : 'background: #002a4a; color: #9DA2A3; border: 2px solid #9DA2A3;'}">üëë Yes</button>
                        </label>
                    </div>
                ` : (participantIsManager ? '<span class="badge badge-warning badge-sm mt-2" style="background: #f59e0b; color: #00203B;">üëë Manager</span>' : '');

                html += `
                    <div class="card bg-base-200 shadow-lg ${isComplete ? 'ring-2 ring-success' : ''}">
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg">${pred.teamName}</h3>
                                    <p class="text-sm text-base-content/60 mt-1">
                                        ${answeredCount} of ${totalQuestions} questions answered
                                    </p>
                                    <div class="mt-3">
                                        <div class="flex justify-between text-xs mb-1">
                                            <span>${percentage}%</span>
                                            <span>${isComplete ? 'Complete!' : 'In progress'}</span>
                                        </div>
                                        <progress class="progress progress-primary w-full" value="${percentage}" max="100"></progress>
                                    </div>
                                    <div class="flex gap-2 flex-wrap items-center">
                                        <button onclick="copyParticipantLink('${pred.userId}', '${pred.teamName}')" class="btn btn-ghost btn-xs mt-3" style="color: #9DA2A3;">
                                            üìã Copy recovery link
                                        </button>
                                        ${managerToggle}
                                        ${isLeagueCreator ? `<button onclick="openDeleteModal('${pred.id}', '${pred.teamName.replace(/'/g, "\\'")}')" class="delete-team-btn mt-3">üóëÔ∏è Delete</button>` : ''}
                                    </div>
                                </div>
                                <div class="ml-4">
                                    ${isComplete
                                        ? '<div class="badge badge-success badge-lg">‚úì</div>'
                                        : `<div class="radial-progress text-primary" style="--value:${percentage}; --size:3rem;">${percentage}%</div>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            participantsDiv.innerHTML = html;
        }

        // Copy participant recovery link
        function copyParticipantLink(userId, teamName) {
            const baseUrl = `${window.location.origin}${window.location.pathname}`;
            const link = `${baseUrl}?league=${currentLeague.slug}&user=${userId}`;

            navigator.clipboard.writeText(link).then(() => {
                showToast(`Recovery link copied for ${teamName}!`);
            }).catch(() => {
                // Fallback for older browsers
                prompt(`Copy this recovery link for ${teamName}:`, link);
            });
        }

        // Toggle manager status for a participant
        async function toggleManager(predictionId, makeManager) {
            try {
                await db.transact([
                    db.tx.predictions[predictionId].update({
                        isManager: makeManager
                    })
                ]);

                const pred = allPredictions.find(p => p.id === predictionId);
                const teamName = pred ? pred.teamName : 'Team';
                showToast(makeManager ? `${teamName} is now a manager!` : `${teamName} is no longer a manager.`);
            } catch (error) {
                console.error('Error toggling manager status:', error);
                showToast('Error updating manager status');
            }
        }

        // ========== DELETE TEAM FUNCTIONS ==========

        // Open delete confirmation modal
        function openDeleteModal(predictionId, teamName) {
            const modal = document.getElementById('deleteTeamModal');
            document.getElementById('deleteTeamId').value = predictionId;
            document.getElementById('deleteTeamName').textContent = teamName;
            modal.showModal();
        }

        // Close delete modal
        function closeDeleteModal() {
            const modal = document.getElementById('deleteTeamModal');
            modal.close();
        }

        // Confirm and execute team deletion
        async function confirmDeleteTeam() {
            const predictionId = document.getElementById('deleteTeamId').value;
            const teamName = document.getElementById('deleteTeamName').textContent;

            if (!predictionId) {
                showToast('Error: No team selected');
                return;
            }

            try {
                await db.transact([
                    db.tx.predictions[predictionId].delete()
                ]);

                closeDeleteModal();
                showToast(`${teamName} has been deleted`);

                // The UI will update automatically via the InstantDB subscription
            } catch (error) {
                console.error('Error deleting team:', error);
                showToast('Error deleting team');
            }
        }

        // Render league name in header
        function renderLeagueName() {
            const container = document.getElementById('leagueNameHeader');
            if (!container || !currentLeague) return;

            const nameSpan = container.querySelector('.league-name-header');
            if (nameSpan) {
                nameSpan.textContent = currentLeague.name;
                container.classList.remove('hidden');
            }
        }

        // Count answered questions
        function countAnsweredQuestions(predictions) {
            if (!predictions) return 0;

            let count = 0;
            questions.forEach(q => {
                if (predictions[q.id] !== undefined && predictions[q.id] !== null && predictions[q.id] !== '') {
                    count++;
                }
            });
            return count;
        }

        // Render all predictions
        function renderAllPredictions() {
            const teamsWithPredictions = allPredictions.filter(p => p.predictions);

            if (teamsWithPredictions.length === 0) {
                console.log('No teams have predictions yet, not showing predictions section');
                return;
            }

            console.log(`Showing all predictions for ${teamsWithPredictions.length} teams`);
            document.getElementById('allPredictionsSection').classList.remove('hidden');

            // Build table with inline styles for better control
            let html = `<table style="width: 100%; border-collapse: collapse; font-size: 14px; background-color: #00203B;">
                <thead>
                    <tr style="background-color: #33F200;">
                        <th style="background-color: #33F200; color: #00203B; font-weight: 700; padding: 12px 8px; text-align: left; position: sticky; left: 0; z-index: 10;">Team</th>`;
            questions.forEach(q => {
                html += `<th style="background-color: #33F200; color: #00203B; font-weight: 700; padding: 12px 8px; white-space: normal; min-width: 80px;">${q.label}</th>`;
            });
            html += `<th style="background-color: #33F200; color: #00203B; font-weight: 700; padding: 12px 8px;">Score</th></tr></thead><tbody>`;

            teamsWithPredictions.forEach(pred => {
                html += `<tr style="background-color: #002a4a;">
                    <td style="background-color: #002a4a; color: #FFFFFF; font-weight: 700; padding: 10px 8px; border-bottom: 1px solid #9DA2A3; position: sticky; left: 0; z-index: 10;">${pred.teamName}</td>`;

                questions.forEach(q => {
                    const value = pred.predictions?.[q.id] || '-';
                    const actual = currentLeague.actualResults?.[q.id];
                    const isCorrect = actual && (value === actual || (q.type === 'number' && parseInt(value) === parseInt(actual)));
                    const bgColor = isCorrect ? '#003320' : '#002a4a';
                    const textColor = isCorrect ? '#33F200' : '#FFFFFF';

                    html += `<td style="background-color: ${bgColor}; color: ${textColor}; padding: 10px 8px; border-bottom: 1px solid #9DA2A3;">${value}</td>`;
                });

                html += `<td style="background-color: #002a4a; color: #33F200; font-weight: 700; padding: 10px 8px; border-bottom: 1px solid #9DA2A3; font-size: 16px;">${pred.score}</td></tr>`;
            });

            // Add actual results row if available
            if (currentLeague.actualResults && Object.keys(currentLeague.actualResults).length > 0) {
                html += `<tr style="background-color: #003320;">
                    <td style="background-color: #003320; color: #33F200; font-weight: 700; padding: 10px 8px; border-top: 3px solid #33F200; position: sticky; left: 0; z-index: 10;">‚úì ACTUAL</td>`;
                questions.forEach(q => {
                    const value = currentLeague.actualResults[q.id];
                    html += `<td style="background-color: #003320; color: #33F200; font-weight: 600; padding: 10px 8px; border-top: 3px solid #33F200;">${value !== undefined && value !== null ? value : '-'}</td>`;
                });
                html += `<td style="background-color: #003320; color: #33F200; font-weight: 700; padding: 10px 8px; border-top: 3px solid #33F200;">-</td></tr>`;
            }

            html += '</tbody></table>';

            document.getElementById('allPredictionsTable').innerHTML = html;
        }

        // Start the app
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
