# ============================================================================
# Netlify Configuration for Super Bowl Prediction App
# ============================================================================
#
# This configuration supports separate QA and Production databases using
# InstantDB. See MULTI_ENV_SETUP.md for detailed setup instructions.
#
# Quick Reference:
#   - Production branch: prod → uses Production database
#   - Other branches: master, feature/* → use QA database
#   - Environment variables: Set VITE_INSTANTDB_APP_ID in Netlify dashboard
#     (Note: Vite requires the VITE_ prefix for client-side env vars)
#

[build]
  # Build command runs TypeScript check and Vite build
  command = "yarn install && yarn build"
  # Publish the dist directory created by Vite
  publish = "dist"

# ============================================================================
# Deploy Contexts - Different environments for different branches
# ============================================================================
#
# Netlify uses "contexts" to determine which environment you're deploying to:
#
#   1. PRODUCTION - Deploys from the prod branch
#      • Uses Production database (set VITE_INSTANTDB_APP_ID for production context)
#      • Live site for real users
#      • URL: https://your-site.netlify.app
#
#   2. BRANCH DEPLOY - Deploys from any other branch (master, feature/*, etc.)
#      • Uses QA database (set VITE_INSTANTDB_APP_ID for branch-deploy context)
#      • Testing and QA environment
#      • URL: https://master--your-site.netlify.app
#
#   3. DEPLOY PREVIEW - Deploys for pull requests
#      • Uses QA database (set VITE_INSTANTDB_APP_ID for deploy-preview context)
#      • Code review and testing
#      • URL: https://deploy-preview-123--your-site.netlify.app
#
# See: https://docs.netlify.com/site-deploys/overview/#deploy-contexts

# Production deployment from prod branch
[context.production]
  command = "yarn install && yarn build"
  publish = "dist"

# Branch deploys (e.g., master → QA)
[context.branch-deploy]
  command = "yarn install && yarn build"
  publish = "dist"

# Deploy previews (pull requests → QA)
[context.deploy-preview]
  command = "yarn install && yarn build"
  publish = "dist"

# ============================================================================
# Environment Variables
# ============================================================================
#
# IMPORTANT: Vite requires the VITE_ prefix for environment variables to be
# exposed to the client-side code. Use VITE_INSTANTDB_APP_ID instead of
# INSTANTDB_APP_ID.
#
# RECOMMENDED: Set environment variables in Netlify Dashboard or CLI
#   - Netlify Dashboard: Site configuration → Environment variables
#   - Netlify CLI: netlify env:set VITE_INSTANTDB_APP_ID "..." --context production
#
# This keeps sensitive values out of your repository and allows different
# values per deploy context without code changes.
#
# ALTERNATIVE: Set environment variables in this file (see examples below)
#   ⚠️  WARNING: Only use this if your repository is PRIVATE
#   ⚠️  App IDs in this file will be visible to anyone with repo access
#
# --- Example Configuration (commented out) ---
#
# Production context - Live database
# [context.production.environment]
#   VITE_INSTANTDB_APP_ID = "your-production-app-id"
#
# Branch deploy context - QA database
# [context.branch-deploy.environment]
#   VITE_INSTANTDB_APP_ID = "your-qa-app-id"
#
# Deploy preview context - QA database
# [context.deploy-preview.environment]
#   VITE_INSTANTDB_APP_ID = "your-qa-app-id"
#
# For detailed setup instructions, see: MULTI_ENV_SETUP.md

# ============================================================================
# Security Headers
# ============================================================================

# Security headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"

# Cache static assets
[[headers]]
  for = "*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# Cache JS/CSS with long expiry (Vite adds content hashes)
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/superbowl/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# ============================================================================
# SPA Routing for /superbowl base path
# ============================================================================
#
# Vite builds with base: '/superbowl/' which means:
#   - HTML references /superbowl/assets/main.css
#   - But build output is at dist/assets/main.css (not dist/superbowl/assets/)
#
# We use Netlify rewrites to map /superbowl/* requests to the actual files.
#
# URL structure:
#   /superbowl/:gameId              - Game home (create/join league)
#   /superbowl/:gameId/:leagueSlug  - Specific league within a game
#
# Examples:
#   /superbowl/lx                   - Super Bowl LX home
#   /superbowl/lx/smith-family      - Smith Family league in Super Bowl LX

# Rewrite static assets: /superbowl/assets/* → /assets/*
[[redirects]]
  from = "/superbowl/assets/*"
  to = "/assets/:splat"
  status = 200

# Rewrite images: /superbowl/images/* → /images/*
[[redirects]]
  from = "/superbowl/images/*"
  to = "/images/:splat"
  status = 200

# Rewrite favicon
[[redirects]]
  from = "/superbowl/favicon.svg"
  to = "/favicon.svg"
  status = 200

# SPA fallback - all other /superbowl/* paths serve index.html
# This handles client-side routing (e.g., /superbowl/lx/league-name)
[[redirects]]
  from = "/superbowl/*"
  to = "/index.html"
  status = 200

# Root redirect to /superbowl (optional - for convenience)
[[redirects]]
  from = "/"
  to = "/superbowl/"
  status = 302
